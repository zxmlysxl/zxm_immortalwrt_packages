<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:佐罗上网管控%></h2>
    <div class="cbi-map-descr">
        <%:基于MAC地址的网络访问时间管控系统%>
        <br><span style="color: #28a745; font-size: 14px;">
            <i class="icon icon-check"></i> <%:能自动判断并切换主/旁路由模式%>
        </span>
    </div>
    
    <fieldset class="cbi-section">
        <legend><%:系统状态%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:服务状态%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="label">正在检查...</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:进程PID%></label>
            <div class="cbi-value-field">
                <code id="service-pid">--</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:统计信息%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:总规则数%></label>
            <div class="cbi-value-field">
                <code id="total-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:启用规则数%></label>
            <div class="cbi-value-field">
                <code id="enabled-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:当前生效规则%></label>
            <div class="cbi-value-field">
                <code id="active-rules">0</code>
            </div>
        </div>
    </fieldset>
    
    <div class="cbi-page-actions">
        <button class="cbi-button cbi-button-apply" onclick="restartService()">
            <%:重启服务%>
        </button>
        <button class="cbi-button cbi-button-reset" onclick="stopService()">
            <%:停止服务%>
        </button>
        <button class="cbi-button cbi-button-action" onclick="startService()">
            <%:启动服务%>
        </button>
        <button class="cbi-button cbi-button-action" onclick="refreshStatus()">
            <%:刷新状态%>
        </button>
        <button class="cbi-button cbi-button-action" onclick="window.location.href='<%=luci.dispatcher.build_url("admin/control/znetcontrol/devices")%>'">
        <i class="icon icon-laptop"></i> <%:查看在线设备%>
    </button>
    </div>
</div>

<script>
// 更快的状态刷新（修复PID显示bug）
function refreshStatus(force = false) {
    const statusEl = document.getElementById('service-status');
    const pidEl = document.getElementById('service-pid');
    
    if (force) {
        statusEl.textContent = '刷新中...';
        statusEl.className = 'label';
        pidEl.textContent = '--';
    }
    
    // 使用更可靠的fetch配置
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_status")%>', {
        method: 'GET',
        credentials: 'include',  // 携带cookie
        headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        },
        timeout: 5000  // 设置超时
    })
    .then(response => {
        // 检查状态码
        if (response.status === 200) {
            return response.json();
        } else if (response.status === 401 || response.status === 403) {
            // 认证问题，重定向到登录页
            window.location.reload();
            throw new Error('需要重新登录');
        } else {
            throw new Error('HTTP ' + response.status);
        }
    })
    .then(data => {
        updateStatusDisplay(data);
    })
    .catch(error => {
        console.error('刷新状态失败:', error);
        
        // 显示具体错误
        statusEl.textContent = '连接失败';
        statusEl.className = 'label error';
        pidEl.textContent = '--';
        
        // 显示错误详情
        document.getElementById('total-rules').textContent = '0';
        document.getElementById('enabled-rules').textContent = '0';
        document.getElementById('active-rules').textContent = '0';
        
        // 如果是网络错误，显示重试按钮
        if (error.message.includes('network') || error.message.includes('Failed')) {
            showRetryButton();
        }
    });
}

function updateStatusDisplay(data) {
    const statusEl = document.getElementById('service-status');
    const pidEl = document.getElementById('service-pid');
    
    // 安全处理数据
    const isRunning = data && (data.running === true || data.running === 'true' || data.running === '1');
    
    if (isRunning) {
        statusEl.textContent = '运行中';
        statusEl.className = 'label success';
    } else {
        statusEl.textContent = '已停止';
        statusEl.className = 'label error';
    }
    
    // PID显示
    if (data && data.pid && data.pid !== "null" && data.pid !== "undefined" && data.pid !== "") {
        pidEl.textContent = data.pid;
    } else {
        pidEl.textContent = '--';
    }
    
    // 规则统计
    if (data) {
        document.getElementById('total-rules').textContent = data.total_rules || 0;
        document.getElementById('enabled-rules').textContent = data.enabled_rules || 0;
        document.getElementById('active-rules').textContent = data.active_rules || 0;
    }
    setTimeout(checkFirewallStatus, 1000);
}

// 添加重试按钮函数
function showRetryButton() {
    const actions = document.querySelector('.cbi-page-actions');
    if (actions && !document.getElementById('retry-btn')) {
        const retryBtn = document.createElement('button');
        retryBtn.id = 'retry-btn';
        retryBtn.className = 'cbi-button cbi-button-reset';
        retryBtn.textContent = '重试连接';
        retryBtn.onclick = function() {
            this.remove();
            refreshStatus(true);
        };
        actions.appendChild(retryBtn);
    }
}

// 防火墙检查函数
function checkFirewallStatus() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/firewall_status")%>')
        .then(response => response.json())
        .then(result => {
            // 如果找到标记表，更新状态显示
            if (result.tables_found && result.tables_found["inet znetcontrol_mark"]) {
                console.log('MAC标记表存在，标记MAC数量:', result.mac_marked_count || 0);
            }
        });
}

function restartService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/restart")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            setTimeout(refreshStatus, 2000);
        })
        .catch(error => {
            console.error('重启服务失败:', error);
            alert('重启服务失败，请重试');
        });
}

function stopService() {
    if (confirm('确定要停止服务吗？')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/stop")%>')
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                refreshStatus(true);
            })
            .catch(error => {
                console.error('停止服务失败:', error);
                alert('停止服务失败，请重试');
            });
    }
}

function startService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/start")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshStatus(true);
        })
        .catch(error => {
            console.error('启动服务失败:', error);
            alert('启动服务失败，请重试');
        });
}

// 页面加载时立即刷新
window.addEventListener('load', function() {
    // 立即刷新一次
    refreshStatus(true);
    
    // 然后每5秒刷新一次
    setInterval(refreshStatus, 5000);
});

// 添加手动刷新按钮点击事件
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('button[onclick*="refreshStatus"]');
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            refreshStatus(true);
            return false;
        };
    }
});
</script>

<style>
/* 保持原有状态标签样式 */
.label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.label.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.label.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
<%+footer%>


