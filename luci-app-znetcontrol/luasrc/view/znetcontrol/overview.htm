<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:佐罗上网管控%></h2>
    <div class="cbi-map-descr"><%:基于MAC地址的网络访问时间管控系统%></div>
    
    <fieldset class="cbi-section">
        <legend><%:系统状态%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:服务状态%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="label">正在检查...</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:运行时间%></label>
            <div class="cbi-value-field">
                <code id="uptime">--</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:统计信息%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:总规则数%></label>
            <div class="cbi-value-field">
                <code id="total-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:启用规则数%></label>
            <div class="cbi-value-field">
                <code id="enabled-rules">0</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:系统操作%></legend>
        <div class="cbi-page-actions">
            <button class="cbi-button cbi-button-apply" onclick="restartService()">
                <%:重启服务%>
            </button>
            <button class="cbi-button cbi-button-action" onclick="refreshStatus()">
                <%:刷新状态%>
            </button>
        </div>
    </fieldset>
</div>

<script>
function refreshStatus() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/get_status")%>')
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('service-status');
            if (data.running) {
                statusEl.textContent = '<%:运行中%>';
                statusEl.className = 'label success';
            } else {
                statusEl.textContent = '<%:已停止%>';
                statusEl.className = 'label error';
            }
            
            document.getElementById('uptime').textContent = data.uptime || '--';
            document.getElementById('total-rules').textContent = data.total_rules || 0;
            document.getElementById('enabled-rules').textContent = data.enabled_rules || 0;
        });
}

function restartService() {
    if (confirm('<%:确定要重启服务吗？%>')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/restart")%>', { 
            method: 'POST' 
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            setTimeout(refreshStatus, 2000);
        });
    }
}

window.onload = refreshStatus;
setInterval(refreshStatus, 30000);
</script>

<style>
.label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.label.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.label.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
<%+footer%>
