<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:佐罗上网管控%></h2>
    <div class="cbi-map-descr"><%:基于MAC地址的网络访问时间管控系统%></div>
    
    <fieldset class="cbi-section">
        <legend><%:系统状态%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:服务状态%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="label">正在检查...</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:进程PID%></label>
            <div class="cbi-value-field">
                <code id="service-pid">--</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:统计信息%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:总规则数%></label>
            <div class="cbi-value-field">
                <code id="total-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:启用规则数%></label>
            <div class="cbi-value-field">
                <code id="enabled-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:当前生效规则%></label>
            <div class="cbi-value-field">
                <code id="active-rules">0</code>
            </div>
        </div>
    </fieldset>
    
    <div class="cbi-page-actions">
        <button class="cbi-button cbi-button-apply" onclick="restartService()">
            <%:重启服务%>
        </button>
        <button class="cbi-button cbi-button-reset" onclick="stopService()">
            <%:停止服务%>
        </button>
        <button class="cbi-button cbi-button-action" onclick="startService()">
            <%:启动服务%>
        </button>
        <button class="cbi-button cbi-button-action" onclick="refreshStatus()">
            <%:刷新状态%>
        </button>
    </div>
</div>

<script>
// 更快的状态刷新（修复PID显示bug）
function refreshStatus(force = false) {
    // 显示正在刷新
    if (force) {
        document.getElementById('service-status').textContent = '刷新中...';
        document.getElementById('service-status').className = 'label';
        document.getElementById('service-pid').textContent = '--';
    }
    
    // 使用fetch但设置超时和重试
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_status")%>', {
        method: 'GET',
        credentials: 'same-origin',  // 携带cookie认证
        headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0',
            'X-Requested-With': 'XMLHttpRequest'  // 标记为AJAX请求
        }
    })
    .then(response => {
        // 检查响应类型
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else if (response.status === 401 || response.status === 403) {
            // 认证失败，重新登录
            throw new Error('认证失败，请刷新页面重新登录');
        } else {
            // 响应不是JSON，尝试解析HTML错误
            return response.text().then(text => {
                console.error('API返回非JSON响应:', text.substring(0, 200));
                throw new Error('API返回格式错误');
            });
        }
    })
    .then(data => {
        updateStatusDisplay(data);
    })
    .catch(error => {
        console.error('刷新状态失败:', error);
        // 重置显示
        document.getElementById('service-status').textContent = '获取失败';
        document.getElementById('service-status').className = 'label error';
        document.getElementById('service-pid').textContent = '--';
        
        // 如果是认证错误，提示重新登录
        if (error.message.includes('认证失败')) {
            alert('登录已过期，请刷新页面重新登录');
        }
    });
}

// 修复PID显示逻辑
function updateStatusDisplay(data) {
    console.log('updateStatusDisplay接收到数据:', data);
    
    const statusEl = document.getElementById('service-status');
    
    // 多种方式判断running状态
    let isRunning = false;
    
    if (typeof data.running === 'boolean') {
        isRunning = data.running;
    } else if (typeof data.running === 'string') {
        isRunning = data.running === 'true' || data.running === '1';
    } else if (typeof data.running === 'number') {
        isRunning = data.running === 1;
    }
    
    console.log('最终判断的running状态:', isRunning);
    
    if (isRunning) {
        console.log('设置为运行中');
        statusEl.textContent = '运行中';
        statusEl.className = 'label success';
    } else {
        console.log('设置为已停止');
        statusEl.textContent = '已停止';
        statusEl.className = 'label error';
    }
    
    // PID显示
    if (data.pid && data.pid !== "null" && data.pid !== "undefined") {
        document.getElementById('service-pid').textContent = data.pid;
        console.log('设置PID为:', data.pid);
    } else {
        document.getElementById('service-pid').textContent = '--';
        console.log('PID为空，设置为--');
    }
    
    // 规则统计
    document.getElementById('total-rules').textContent = data.total_rules || 0;
    document.getElementById('enabled-rules').textContent = data.enabled_rules || 0;
    document.getElementById('active-rules').textContent = data.active_rules || 0;
    
    console.log('显示更新完成');
}

function restartService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/restart")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            setTimeout(refreshStatus, 2000);
        })
        .catch(error => {
            console.error('重启服务失败:', error);
            alert('重启服务失败，请重试');
        });
}

function stopService() {
    if (confirm('确定要停止服务吗？')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/stop")%>')
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                refreshStatus(true);
            })
            .catch(error => {
                console.error('停止服务失败:', error);
                alert('停止服务失败，请重试');
            });
    }
}

function startService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/start")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshStatus(true);
        })
        .catch(error => {
            console.error('启动服务失败:', error);
            alert('启动服务失败，请重试');
        });
}

// 页面加载时立即刷新
window.addEventListener('load', function() {
    // 立即刷新一次
    refreshStatus(true);
    
    // 然后每5秒刷新一次
    setInterval(refreshStatus, 5000);
});

// 添加手动刷新按钮点击事件
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('button[onclick*="refreshStatus"]');
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            refreshStatus(true);
            return false;
        };
    }
});
</script>

<style>
/* 保持原有状态标签样式 */
.label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.label.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.label.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
<%+footer%>
