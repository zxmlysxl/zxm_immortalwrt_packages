<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:系统状态%></h2>
    
    <fieldset class="cbi-section">
        <legend><%:服务信息%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:服务状态%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="label">检查中...</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:运行时间%></label>
            <div class="cbi-value-field">
                <code id="uptime">--</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:防火墙状态%></label>
            <div class="cbi-value-field">
                <code id="firewall-status">检查中...</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:系统操作%></legend>
        <div class="cbi-page-actions">
            <button class="cbi-button cbi-button-apply" onclick="restartService()">
                <%:重启服务%>
            </button>
            <button class="cbi-button cbi-button-action" onclick="updateStatus()">
                <%:刷新状态%>
            </button>
            <button class="cbi-button cbi-button-reset" onclick="clearLogs()">
                <%:清空日志%>
            </button>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:实时日志%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:系统日志%></label>
            <div class="cbi-value-field">
                <div style="margin-bottom: 5px;">
                    <button class="cbi-button cbi-button-action" onclick="refreshLogs()" style="padding: 4px 10px;">
                        <%:刷新日志%>
                    </button>
                </div>
                <pre id="log-content" style="height: 250px; overflow-y: auto; background: #f5f5f5; padding: 10px; border: 1px solid #ddd; border-radius: 3px;"></pre>
            </div>
        </div>
    </fieldset>
</div>

<script>
function updateStatus() {
    // 获取服务状态
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/get_status")%>')
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('service-status');
            if (data.running) {
                statusEl.textContent = '<%:运行中%>';
                statusEl.className = 'label success';
            } else {
                statusEl.textContent = '<%:已停止%>';
                statusEl.className = 'label error';
            }
            
            document.getElementById('uptime').textContent = data.uptime || '--';
        });
    
    // 获取防火墙状态
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/firewall_status")%>')
        .then(response => response.json())
        .then(data => {
            const firewallEl = document.getElementById('firewall-status');
            if (data.exists) {
                firewallEl.textContent = '<%:已加载 (' + (data.blocked_count || 0) + '个规则)%>';
            } else {
                firewallEl.textContent = '<%:未找到%>';
            }
        });
    
    // 获取日志
    refreshLogs();
}

function refreshLogs() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/logs")%>')
        .then(response => response.json())
        .then(logs => {
            const logElement = document.getElementById('log-content');
            if (logs.length === 0) {
                logElement.textContent = '<%:暂无日志%>';
            } else {
                logElement.textContent = logs.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
        });
}

function restartService() {
    if (confirm('<%:确定要重启服务吗？%>')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/restart")%>', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                setTimeout(updateStatus, 2000);
            });
    }
}

function clearLogs() {
    if (confirm('<%:确定要清空所有日志吗？%>')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/clear_logs")%>', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                refreshLogs();
            });
    }
}

// 页面加载时初始化
window.onload = updateStatus;
// 每30秒自动更新一次
setInterval(updateStatus, 30000);
</script>

<style>
.label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.label.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.label.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
<%+footer%>
