<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:ç³»ç»Ÿæ—¥å¿—%></h2>
    
    <!-- æ—¥å¿—è®¾ç½® -->
    <fieldset class="cbi-section">
        <legend><%:æ—¥å¿—è®¾ç½®%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:æ—¥å¿—çº§åˆ«%></label>
            <div class="cbi-value-field">
                <select id="log-level-setting" onchange="changeLogLevel()" style="width: 200px;">
                    <option value="info">åŸºæœ¬ä¿¡æ¯</option>
                    <option value="debug">è°ƒè¯•ä¿¡æ¯</option>
                </select>
                <button class="cbi-button cbi-button-action" onclick="saveLogSettings()" style="margin-left: 10px;">
                    <%:ä¿å­˜è®¾ç½®%>
                </button>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:å®æ—¶æ—¥å¿—%></legend>
        <div class="cbi-value">
            <div class="cbi-value-field" style="width: 100%;">
                <!-- ä¼˜åŒ–çš„å·¥å…·æ  -->
                <div class="log-toolbar" style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="cbi-button cbi-button-action" onclick="refreshLogs()">
                            <i class="icon icon-refresh"></i> åˆ·æ–°æ—¥å¿—
                        </button>
                        <button class="cbi-button cbi-button-reset" onclick="clearLogs()">
                            <i class="icon icon-trash"></i> æ¸…ç©ºæ—¥å¿—
                        </button>
                        <button class="cbi-button cbi-button-apply" onclick="downloadLogs()">
                            <i class="icon icon-download"></i> ä¸‹è½½æ—¥å¿—
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <button class="cbi-button" onclick="showSystemStatus()" title="æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€">
                            <i class="icon icon-info"></i> ç³»ç»ŸçŠ¶æ€
                        </button>
                        <button class="cbi-button" onclick="toggleFullscreen()" title="åˆ‡æ¢å…¨å±æ¨¡å¼">
                            <i class="icon icon-maximize"></i> å…¨å±
                        </button>
                        <button class="cbi-button" onclick="scrollToBottom()" title="æ»šåŠ¨åˆ°åº•éƒ¨">
                            <i class="icon icon-arrow-down"></i> åˆ°åº•éƒ¨
                        </button>
                        <button class="cbi-button" onclick="scrollToTop()" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">
                            <i class="icon icon-arrow-up"></i> åˆ°é¡¶éƒ¨
                        </button>
                        
                        <span style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 12px;">è¿‡æ»¤:</span>
                            <select id="log-level" onchange="filterLogs()" style="padding: 5px 10px; border-radius: 4px;">
                                <option value="all">å…¨éƒ¨æ—¥å¿—</option>
                                <option value="info">ä»…ä¿¡æ¯</option>
                                <option value="success">ä»…æˆåŠŸ</option>
                                <option value="warn">ä»…è­¦å‘Š</option>
                                <option value="error">ä»…é”™è¯¯</option>
                                <option value="rule">ä»…è§„åˆ™ç›¸å…³</option>
                            </select>
                            
                            <span style="font-size: 12px;">æ˜¾ç¤º:</span>
                            <select id="log-lines" onchange="changeMaxLines()" style="padding: 5px 10px; border-radius: 4px;">
                                <option value="100">100è¡Œ</option>
                                <option value="500">500è¡Œ</option>
                                <option value="1000" selected>1000è¡Œ</option>
                                <option value="2000">2000è¡Œ</option>
                                <option value="5000">5000è¡Œ</option>
                            </select>
                            
                            <span style="font-size: 12px;">å¤‡ä»½:</span>
                            <select id="log-backup" onchange="changeLogBackup()" style="padding: 5px 10px; border-radius: 4px;">
                                <option value="0">ä¸å¤‡ä»½ï¼ˆç›´æ¥æ¸…ç©ºï¼‰</option>
                                <option value="1">å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰</option>
                            </select>
                            
                            <span style="font-size: 12px;">åˆ·æ–°:</span>
                            <select id="refresh-interval" onchange="changeRefreshInterval()" style="padding: 5px 10px; border-radius: 4px;">
                                <option value="5">5ç§’</option>
                                <option value="10">10ç§’</option>
                                <option value="30" selected>30ç§’</option>
                                <option value="60">60ç§’</option>
                                <option value="120">2åˆ†é’Ÿ</option>
                                <option value="300">5åˆ†é’Ÿ</option>
                                <option value="0">ä¸åˆ·æ–°</option>
                            </select>
                            
                            <button class="cbi-button" onclick="toggleAutoRefresh()" id="auto-refresh-btn" title="åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°">
                                <i class="icon icon-clock"></i> è‡ªåŠ¨åˆ·æ–°
                            </button>
                        </span>
                    </div>
                </div>
                
                <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
                <div style="width: 100%; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <div style="font-size: 12px; color: #666;">
                            <i class="icon icon-file-text"></i> æ—¥å¿—æ–‡ä»¶: 
                            <code>/var/log/znetcontrol.log</code>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            å…± <span id="line-count">0</span> è¡Œ | 
                            åˆ·æ–°é—´éš”: <span id="refresh-display">30</span>ç§’ |
                            å¤‡ä»½æ¨¡å¼: <span id="backup-display">ä¸å¤‡ä»½</span> |
                            æœ€åæ›´æ–°: <span id="last-update">--</span>
                        </div>
                    </div>
                    
                    <pre id="log-content" style="
                        width: 100%;
                        height: 500px;
                        overflow: auto;
                        background: #1a1a1a;
                        color: #e0e0e0;
                        padding: 15px;
                        border: 2px solid #333;
                        border-radius: 8px;
                        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
                        font-size: 12px;
                        line-height: 1.4;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        margin: 0;
                    "></pre>
                    
                    <!-- ç§»åŠ¨ç«¯æµ®åŠ¨æŒ‰é’® -->
                    <div id="mobile-float-buttons" style="display: none; position: fixed; bottom: 80px; right: 20px; z-index: 1000;">
                        <button onclick="refreshLogs()" style="
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            background: #007bff;
                            color: white;
                            border: none;
                            margin-bottom: 10px;
                            font-size: 20px;
                            cursor: pointer;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        ">
                            <i class="icon icon-refresh"></i>
                        </button>
                        <button onclick="scrollToBottom()" style="
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            background: #28a745;
                            color: white;
                            border: none;
                            font-size: 20px;
                            cursor: pointer;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        ">
                            <i class="icon icon-arrow-down"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
    
    <!-- ç³»ç»ŸçŠ¶æ€ -->
    <fieldset class="cbi-section" id="system-status" style="display: none;">
        <legend><%:ç³»ç»ŸçŠ¶æ€%></legend>
        <div class="cbi-value">
            <div class="cbi-value-field">
                <pre id="status-content" style="
                    background: #2d2d2d;
                    color: #e0e0e0;
                    padding: 15px;
                    border-radius: 5px;
                    font-family: monospace;
                    white-space: pre;
                    overflow: auto;
                    max-height: 300px;
                "></pre>
            </div>
        </div>
    </fieldset>
    
    <!-- æ—¥å¿—è¯´æ˜ -->
    <fieldset class="cbi-section">
        <legend><%:æ—¥å¿—è¯´æ˜%></legend>
        <div class="cbi-value">
            <div class="cbi-value-field">
                <div id="log-description-container">
                    <!-- è¿™é‡Œçš„å†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </fieldset>
</div>

<script>
// ========== å·¥å…·å‡½æ•° ==========
function escapeHtml(text) {
    if (text == null) return '';
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br>');
}

// ========== å…¨å±€å˜é‡ ==========
let isMobile = false;
let maxLines = 1000;
let autoRefreshInterval = null;
let autoRefreshEnabled = true;
let autoRefreshIntervalMs = 30000; // é»˜è®¤30ç§’
let logBackupEnabled = "0"; // é»˜è®¤ä¸å¤‡ä»½
let currentLogs = [];

// ========== æ—¥å¿—çº§åˆ«è®¾ç½® ==========
function loadLogSettings() {
    return fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_config")%>')
        .then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        })
        .then(config => {
            // æ›´æ–°æ—¥å¿—çº§åˆ«
            if (config.log_level) {
                const logLevelSelect = document.getElementById('log-level-setting');
                if (logLevelSelect) {
                    logLevelSelect.value = config.log_level;
                }
            }
            return config;
        })
        .catch(error => {
            console.warn('åŠ è½½æ—¥å¿—è®¾ç½®å¤±è´¥:', error);
            return { log_level: 'info' };
        });
}

function changeLogLevel() {
    const select = document.getElementById('log-level-setting');
    const level = select.value;
    console.log('æ—¥å¿—çº§åˆ«æ›´æ”¹ä¸º:', level);
}

function saveLogSettings() {
    const level = document.getElementById('log-level-setting').value;
    
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/save_config")%>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            log_level: level
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('æ—¥å¿—è®¾ç½®å·²ä¿å­˜ï¼Œéœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆ');
            // å¯ä»¥æç¤ºç”¨æˆ·é‡å¯æœåŠ¡
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    });
}

// ========== é…ç½®ç®¡ç† ==========
function loadConfig() {
    // å°è¯•ä»æœåŠ¡å™¨è·å–é…ç½®ï¼Œå¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤å€¼
    return fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_config")%>')
        .then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        })
        .then(config => {
            console.log('åŠ è½½é…ç½®:', config);
            
            // æ›´æ–°è‡ªåŠ¨åˆ·æ–°é—´éš”
            if (config.log_auto_refresh) {
                autoRefreshIntervalMs = parseInt(config.log_auto_refresh) * 1000;
                
                // æ›´æ–°é€‰æ‹©æ¡†
                const refreshSelect = document.getElementById('refresh-interval');
                if (refreshSelect) {
                    refreshSelect.value = config.log_auto_refresh;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                const refreshDisplay = document.getElementById('refresh-display');
                if (refreshDisplay) {
                    refreshDisplay.textContent = config.log_auto_refresh;
                }
            }
            
            // æ›´æ–°æœ€å¤§è¡Œæ•°
            if (config.log_max_lines) {
                maxLines = parseInt(config.log_max_lines);
                const linesSelect = document.getElementById('log-lines');
                if (linesSelect) {
                    linesSelect.value = config.log_max_lines;
                }
            }
            
            // æ›´æ–°å¤‡ä»½è®¾ç½®
            if (config.log_backup_enabled) {
                logBackupEnabled = config.log_backup_enabled;
                const backupSelect = document.getElementById('log-backup');
                if (backupSelect) {
                    backupSelect.value = config.log_backup_enabled;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                const backupDisplay = document.getElementById('backup-display');
                if (backupDisplay) {
                    backupDisplay.textContent = config.log_backup_enabled === "1" ? "å¤‡ä»½æ¨¡å¼" : "ä¸å¤‡ä»½";
                }
            }
            
            // ========== æ–°å¢ï¼šè‡ªåŠ¨åˆ·æ–°çŠ¶æ€ ==========
            // æ ¹æ®é—´éš”æ—¶é—´è®¾ç½®è‡ªåŠ¨åˆ·æ–°æŒ‰é’®çŠ¶æ€
            const refreshSelect = document.getElementById('refresh-interval');
            const intervalValue = refreshSelect ? parseInt(refreshSelect.value) : 30;
            
            // å¦‚æœé—´éš”æ—¶é—´å¤§äº0ï¼Œè‡ªåŠ¨å¼€å¯åˆ·æ–°
            autoRefreshEnabled = intervalValue > 0;
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const btn = document.getElementById('auto-refresh-btn');
            if (btn) {
                if (autoRefreshEnabled && autoRefreshIntervalMs > 0) {
                    const seconds = autoRefreshIntervalMs / 1000;
                    btn.innerHTML = `<i class="icon icon-clock"></i> æš‚åœåˆ·æ–° (${seconds}ç§’)`;
                    btn.style.backgroundColor = '';
                    btn.title = `è‡ªåŠ¨åˆ·æ–°é—´éš”: ${seconds}ç§’`;
                    
                    // è‡ªåŠ¨å¯åŠ¨åˆ·æ–°
                    startAutoRefresh();
                } else {
                    btn.innerHTML = '<i class="icon icon-clock"></i> å¯åŠ¨åˆ·æ–°';
                    btn.style.backgroundColor = '#dc3545';
                    btn.title = 'ç‚¹å‡»å¯ç”¨è‡ªåŠ¨åˆ·æ–°';
                }
            }
            
            console.log('é…ç½®åŠ è½½å®Œæˆ:', {
                autoRefreshEnabled: autoRefreshEnabled,
                intervalMs: autoRefreshIntervalMs,
                maxLines: maxLines,
                backupEnabled: logBackupEnabled
            });
            
            return config;
        })
        .catch(error => {
            console.warn('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
            // ä½¿ç”¨é»˜è®¤å€¼
            autoRefreshIntervalMs = 30000;
            maxLines = 1000;
            logBackupEnabled = "0";
            autoRefreshEnabled = true;  // é»˜è®¤å¯ç”¨
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            const btn = document.getElementById('auto-refresh-btn');
            if (btn) {
                btn.innerHTML = `<i class="icon icon-clock"></i> æš‚åœåˆ·æ–° (30ç§’)`;
                btn.style.backgroundColor = '';
            }
            
            return {
                log_auto_refresh: '30',
                log_max_lines: '1000',
                log_backup_enabled: '0'
            };
        });
}

function saveConfig(config) {
    return fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/save_config")%>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => {
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('é…ç½®ä¿å­˜æˆåŠŸ');
        }
        return data;
    })
    .catch(error => {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        return { success: false, message: error.message };
    });
}

// ========== æ ¸å¿ƒåŠŸèƒ½ ==========
function updateTimestamp() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('zh-CN');
    const timeStr = now.toLocaleTimeString('zh-CN', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('last-update').textContent = dateStr + ' ' + timeStr;
}

function refreshLogs() {
    const logElement = document.getElementById('log-content');
    const lineCountElement = document.getElementById('line-count');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    logElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #888;">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>';
    
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_logs")%>')
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTPé”™è¯¯: ' + response.status);
            }
            return response.json();
        })
        .then(logs => {
            // ========== ä¿®å¤ï¼šæ­£ç¡®å¤„ç†ç©ºæ•°ç»„ ==========
            if (!Array.isArray(logs)) {
                throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
            }
            
            currentLogs = logs; // ä¿å­˜æ—¥å¿—ç”¨äºè¿‡æ»¤
            
            if (logs.length === 0) {
                // ä¿®å¤ï¼šç©ºæ—¥å¿—æ—¶æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œè€Œéé”™è¯¯
                logElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #888;">æš‚æ— æ—¥å¿—è®°å½•</div>';
                lineCountElement.textContent = '0';
            } else {
                // é™åˆ¶æ˜¾ç¤ºè¡Œæ•°
                let displayLogs = logs;
                if (logs.length > maxLines) {
                    displayLogs = logs.slice(-maxLines);
                }
                
                // åº”ç”¨å½“å‰è¿‡æ»¤å™¨
                const level = document.getElementById('log-level').value;
                if (level !== 'all') {
                    displayLogs = filterByLevel(displayLogs, level);
                }
                
                let html = '';
                displayLogs.forEach(log => {
                    html += formatLogLine(log) + '<br>';
                });
                logElement.innerHTML = html;
                lineCountElement.textContent = displayLogs.length;
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    logElement.scrollTop = logElement.scrollHeight;
                }, 100);
            }
            updateTimestamp();
        })
        .catch(error => {
            console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
            logElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #f44747;">' +
                                  'åŠ è½½æ—¥å¿—å¤±è´¥<br>' + escapeHtml(error.message) + '<br>' +
                                  'è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            lineCountElement.textContent = '0';
        });
}


function filterByLevel(logs, level) {
    return logs.filter(log => {
        if (!log) return false;
        
        switch (level) {
            case 'info':
                return log.includes(' - ') && 
                       !log.includes('âœ…') && 
                       !log.includes('âš ') && 
                       !log.includes('âŒ') &&
                       !log.includes('ğŸ“Š') &&
                       !log.includes('ğŸ”•') &&
                       !log.includes('â°');
            case 'success':
                return log.includes('âœ…');
            case 'warn':
                return log.includes('âš ');
            case 'error':
                return log.includes('âŒ');
            case 'rule':
                return log.includes('è§£æè§„åˆ™') || 
                       log.includes('æˆåŠŸæ·»åŠ ') || 
                       log.includes('è§„åˆ™ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´') ||
                       log.includes('è§„åˆ™åŠ è½½ç»Ÿè®¡') ||
                       log.includes('æ·»åŠ å¤±è´¥') ||
                       log.includes('è§„åˆ™å·²ç¦ç”¨') ||
                       log.includes('ç›®æ ‡ç±»å‹');
            default:
                return true;
        }
    });
}

function filterLogs() {
    const level = document.getElementById('log-level').value;
    
    if (level === 'all') {
        refreshLogs();
        return;
    }
    
    const logElement = document.getElementById('log-content');
    const lineCountElement = document.getElementById('line-count');
    
    if (currentLogs.length === 0) {
        // ä¿®å¤ï¼šç©ºæ—¥å¿—æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
        logElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #888;">æ²¡æœ‰æ—¥å¿—æ•°æ®</div>';
        lineCountElement.textContent = '0';
        return;
    }
    
    // é™åˆ¶æ˜¾ç¤ºè¡Œæ•°
    let displayLogs = currentLogs;
    if (currentLogs.length > maxLines) {
        displayLogs = currentLogs.slice(-maxLines);
    }
    
    const filtered = filterByLevel(displayLogs, level);
    
    if (filtered.length === 0) {
        logElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #888;">æ²¡æœ‰åŒ¹é…çš„æ—¥å¿—</div>';
        lineCountElement.textContent = '0';
    } else {
        let html = '';
        filtered.forEach(log => {
            html += formatLogLine(log) + '<br>';
        });
        logElement.innerHTML = html;
        lineCountElement.textContent = filtered.length;
    }
}


function formatLogLine(log) {
    if (!log) return '';
    
    // å¤„ç†åˆ†éš”çº¿
    if (log.includes('â•') || log.includes('â•‘') || log.includes('â•”') || 
        log.includes('â•š') || log.includes('â”€') || log.includes('â”‚') ||
        log.includes('â”Œ') || log.includes('â””')) {
        return '<span style="color: #4ec9b0;">' + escapeHtml(log) + '</span>';
    }
    
    // å¤„ç†è§„åˆ™ç»Ÿè®¡
    if (log.includes('ğŸ“Š')) {
        return '<span style="color: #4ec9b0; font-weight: bold;">' + escapeHtml(log) + '</span>';
    }
    
    // å¤„ç†æ›´æ–°å¼€å§‹/ç»“æŸæ ‡è®°
    if (log.includes('======') || log.includes('============')) {
        return '<span style="color: #569cd6; font-weight: bold;">' + escapeHtml(log) + '</span>';
    }
    
    // å¤„ç†å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—
    const timestampMatch = log.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})(?: - (.*))?$/);
    if (timestampMatch) {
        const timestamp = timestampMatch[1];
        const message = timestampMatch[2] || '';
        
        let color = '#9cdcfe'; // é»˜è®¤ä¿¡æ¯è‰²
        let icon = '';
        
        if (message.includes('âœ…')) {
            color = '#6a9955';
            icon = 'âœ… ';
        } else if (message.includes('âŒ')) {
            color = '#f44747';
            icon = 'âŒ ';
        } else if (message.includes('âš ')) {
            color = '#ffcc00';
            icon = 'âš  ';
        } else if (message.includes('â°')) {
            color = '#ce9178';
            icon = 'â° ';
        } else if (message.includes('ğŸ”•')) {
            color = '#b5cea8';
            icon = 'ğŸ”• ';
        } else if (message.includes('ğŸ”’')) {
            color = '#c586c0';
            icon = 'ğŸ”’ ';
        } else if (message.includes('ğŸ”—')) {
            color = '#569cd6';
            icon = 'ğŸ”— ';
        } else if (message.includes('è§£æè§„åˆ™')) {
            color = '#c586c0';
        } else if (message.includes('é‡æ–°åŠ è½½è§„åˆ™') || message.includes('ä»é…ç½®æ–‡ä»¶åŠ è½½è§„åˆ™')) {
            color = '#569cd6';
        }
        
        return '<span style="color: #569cd6;">' + escapeHtml(timestamp) + '</span> - ' +
               '<span style="color: ' + color + '">' + icon + escapeHtml(message) + '</span>';
    }
    
    return '<span style="color: #9cdcfe;">' + escapeHtml(log) + '</span>';
}

function clearLogs() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ' + (logBackupEnabled === "1" ? '\nï¼ˆå¯ç”¨å¤‡ä»½æ¨¡å¼ï¼Œå°†ä¿ç•™7å¤©å†å²æ—¥å¿—ï¼‰' : ''))) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/clear_logs")%>', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTPé”™è¯¯: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                setTimeout(refreshLogs, 1000);
            } else {
                alert('æ“ä½œå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        });
    }
}

function downloadLogs() {
    const content = currentLogs.join('\n');
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'znetcontrol_' + new Date().toISOString().slice(0, 10) + '.log';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ========== ç³»ç»ŸçŠ¶æ€åŠŸèƒ½ ==========
function showSystemStatus() {
    const statusSection = document.getElementById('system-status');
    const statusContent = document.getElementById('status-content');
    
    statusContent.textContent = 'æ­£åœ¨åŠ è½½ç³»ç»ŸçŠ¶æ€...';
    statusSection.style.display = 'block';
    
    Promise.all([
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_status")%>').then(r => r.json()).catch(() => null),
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_devices")%>').then(r => r.json()).catch(() => []),
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/firewall_status")%>').then(r => r.json()).catch(() => ({
            table_exists: false,
            blocked_count: 0,
            mac_count: 0,
            ip_count: 0,
            tables_found: {}
        }))
    ])
    .then(([status, devices, firewallStatus]) => {
        const now = new Date();
        const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
        const weekday = weekdays[now.getDay()];
        
        // æ„å»ºé˜²ç«å¢™è¡¨çŠ¶æ€æ˜¾ç¤º
        let firewallTableDisplay = "âŒ ä¸å­˜åœ¨";
        let firewallTablesList = "";
        
        if (firewallStatus.table_exists && firewallStatus.tables_found) {
            const tables = Object.keys(firewallStatus.tables_found);
            if (tables.length > 0) {
                firewallTableDisplay = "âœ… å­˜åœ¨";
                
                // æ ¼å¼åŒ–è¡¨åæ˜¾ç¤º
                const tableNames = tables.map(table => {
                    if (table === "inet znetcontrol") return "inet";
                    if (table === "ip znetcontrol") return "ipv4";
                    if (table === "ip6 znetcontrol") return "ipv6";
                    if (table === "bridge znetcontrol") return "bridge";
                    if (table === "iptables") return "iptables";
                    if (table === "idlist") return "idlist";
                    return table;
                });
                
                firewallTablesList = ` (${tableNames.join('ã€')})`;
            }
        }
        
        // æ„å»ºçŠ¶æ€æ–‡æœ¬
        let statusText = `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä½ç½—ä¸Šç½‘ç®¡æ§ç³»ç»ŸçŠ¶æ€                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ§åˆ¶æ¨¡å¼: IP/MACåœ°å€æ—¶é—´æ§åˆ¶              â”‚
â”‚    ç‰ˆæœ¬: ${status?.version || '2.0.0'} | ä½œè€…: zuoxm  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰æ—¶é—´: ${now.toLocaleDateString('zh-CN')} ${now.toLocaleTimeString('zh-CN', {hour12: false})} â”‚
â”‚ æ˜ŸæœŸ: ${weekday}                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœåŠ¡çŠ¶æ€: ${status?.running ? 'âœ… è¿è¡Œä¸­' : 'âŒ å·²åœæ­¢'} â”‚
â”‚ è¿è¡Œæ—¶é—´: ${status?.uptime || '--'}        â”‚
â”‚ è¿›ç¨‹PID: ${status?.pid || '--'}            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§„åˆ™ç»Ÿè®¡:                                  â”‚
â”‚  æ€»è§„åˆ™æ•°: ${status?.total_rules || 0}     â”‚
â”‚  å·²å¯ç”¨è§„åˆ™: ${status?.enabled_rules || 0} â”‚
â”‚  å½“å‰ç”Ÿæ•ˆè§„åˆ™: ${status?.active_rules || 0} â”‚
â”‚  é˜²ç«å¢™è¡¨: ${firewallTableDisplay}${firewallTablesList} â”‚
â”‚  MACè§„åˆ™æ•°: ${firewallStatus?.mac_count || 0} â”‚
â”‚  IPè§„åˆ™æ•°: ${firewallStatus?.ip_count || 0} â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç½‘ç»œç»Ÿè®¡:                                  â”‚
â”‚  å½“å‰åœ¨çº¿è®¾å¤‡: ${devices?.length || 0}     â”‚
â”‚  æ—¥å¿—æ˜¾ç¤º: ${document.getElementById('line-count')?.textContent || 0} è¡Œ â”‚
â”‚  æœ€åæ›´æ–°: ${document.getElementById('last-update')?.textContent || '--'} â”‚
â”‚  å¤‡ä»½æ¨¡å¼: ${logBackupEnabled === "1" ? "âœ… å¯ç”¨" : "âŒ ç¦ç”¨"} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`;
        
        const activeRules = status?.active_rules || 0;
        
        // æ·»åŠ ç”Ÿæ•ˆè®¾å¤‡ä¿¡æ¯
        if (firewallStatus?.devices && firewallStatus.devices.length > 0) {
            statusText += '\n\nå½“å‰ç”Ÿæ•ˆè®¾å¤‡:';
            firewallStatus.devices.forEach((device, index) => {
                const typeDisplay = device.type === 'mac' ? 'MAC' : 
                                   device.type === 'ipv4' ? 'IP' : 
                                   device.type || 'æœªçŸ¥';
                const name = device.name || `è§„åˆ™${index + 1}`;
                statusText += `\n${index + 1}. ${name} (${device.address}) [${typeDisplay}]`;
            });
        } else if (activeRules > 0) {
            statusText += `\n\nå½“å‰ç”Ÿæ•ˆè®¾å¤‡: ${activeRules}ä¸ª`;
        } else {
            statusText += '\n\nå½“å‰ç”Ÿæ•ˆè®¾å¤‡: æ— ';
        }
        
        // æ·»åŠ è¡¨æ ¼ç»Ÿè®¡ä¿¡æ¯
        if (firewallStatus.tables_found) {
            const tableCount = Object.keys(firewallStatus.tables_found).length;
            statusText += `\n\né˜²ç«å¢™è¡¨ç»Ÿè®¡:`;
            statusText += `\nâ€¢ æ‰¾åˆ°è¡¨æ•°é‡: ${tableCount}ä¸ª`;
            statusText += `\nâ€¢ æ€»è§„åˆ™æ•°: ${firewallStatus.blocked_count || 0}æ¡`;
            
            if (firewallStatus.mac_count > 0) {
                statusText += `\nâ€¢ MACè¿‡æ»¤è§„åˆ™: ${firewallStatus.mac_count}æ¡`;
            }
            if (firewallStatus.ip_count > 0) {
                statusText += `\nâ€¢ IPè¿‡æ»¤è§„åˆ™: ${firewallStatus.ip_count}æ¡`;
            }
        }
        
        statusContent.textContent = statusText;
    })
    .catch(error => {
        console.error('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        statusContent.textContent = 'è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥\né”™è¯¯: ' + error.message;
    });
}

// ========== è¾…åŠ©åŠŸèƒ½ ==========
function toggleFullscreen() {
    const logElement = document.getElementById('log-content');
    if (logElement.style.height === '80vh') {
        logElement.style.height = '500px';
    } else {
        logElement.style.height = '80vh';
    }
}

function scrollToBottom() {
    const logElement = document.getElementById('log-content');
    logElement.scrollTop = logElement.scrollHeight;
}

function scrollToTop() {
    const logElement = document.getElementById('log-content');
    logElement.scrollTop = 0;
}

function changeMaxLines() {
    const select = document.getElementById('log-lines');
    const newMaxLines = parseInt(select.value);
    
    if (newMaxLines !== maxLines) {
        maxLines = newMaxLines;
        
        // ä¿å­˜é…ç½®
        saveConfig({
            log_max_lines: select.value,
            log_backup_enabled: logBackupEnabled
        }).then(() => {
            refreshLogs();
        });
    }
}

function changeLogBackup() {
    const select = document.getElementById('log-backup');
    const newBackup = select.value;
    
    if (newBackup !== logBackupEnabled) {
        logBackupEnabled = newBackup;
        
        // æ›´æ–°æ˜¾ç¤º
        const backupDisplay = document.getElementById('backup-display');
        if (backupDisplay) {
            backupDisplay.textContent = newBackup === "1" ? "å¤‡ä»½æ¨¡å¼" : "ä¸å¤‡ä»½";
        }
        
        // ä¿å­˜é…ç½®
        saveConfig({
            log_max_lines: maxLines.toString(),
            log_backup_enabled: newBackup
        });
    }
}

function changeRefreshInterval() {
    const select = document.getElementById('refresh-interval');
    const intervalSeconds = parseInt(select.value);
    const newIntervalMs = intervalSeconds * 1000;
    
    // æ›´æ–°æ˜¾ç¤º
    const refreshDisplay = document.getElementById('refresh-display');
    if (refreshDisplay) {
        refreshDisplay.textContent = intervalSeconds === 0 ? 'æ‰‹åŠ¨' : intervalSeconds;
    }
    
    // æ ¹æ®é—´éš”æ—¶é—´æ›´æ–°è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
    if (intervalSeconds > 0) {
        autoRefreshEnabled = true;
        const btn = document.getElementById('auto-refresh-btn');
        if (btn) {
            btn.innerHTML = `<i class="icon icon-clock"></i> æš‚åœåˆ·æ–° (${intervalSeconds}ç§’)`;
            btn.style.backgroundColor = '';
        }
        startAutoRefresh();
    } else {
        autoRefreshEnabled = false;
        const btn = document.getElementById('auto-refresh-btn');
        if (btn) {
            btn.innerHTML = '<i class="icon icon-clock"></i> å¯åŠ¨åˆ·æ–°';
            btn.style.backgroundColor = '#dc3545';
        }
        stopAutoRefresh();
    }
    
    // ä¿å­˜é…ç½®
    const config = {
        log_auto_refresh: select.value,
        log_max_lines: maxLines.toString(),
        log_backup_enabled: logBackupEnabled,
        auto_refresh_enabled: intervalSeconds > 0 ? "1" : "0"  // æ–°å¢ï¼šä¿å­˜çŠ¶æ€
    };
    
    saveConfig(config).then(() => {
        // æ›´æ–°é—´éš”
        autoRefreshIntervalMs = newIntervalMs;
        
        // é‡æ–°é…ç½®è‡ªåŠ¨åˆ·æ–°
        if (autoRefreshEnabled && intervalSeconds > 0) {
            startAutoRefresh();
        }
    });
}

function startAutoRefresh() {
    stopAutoRefresh();
    
    if (autoRefreshEnabled && autoRefreshIntervalMs > 0) {
        autoRefreshInterval = setInterval(refreshLogs, autoRefreshIntervalMs);
        
        const btn = document.getElementById('auto-refresh-btn');
        if (btn) {
            const seconds = autoRefreshIntervalMs / 1000;
            btn.innerHTML = `<i class="icon icon-clock"></i> æš‚åœåˆ·æ–° (${seconds}ç§’)`;
            btn.style.backgroundColor = '';
            btn.title = `è‡ªåŠ¨åˆ·æ–°é—´éš”: ${seconds}ç§’`;
        }
        
        console.log(`è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${autoRefreshIntervalMs}ms`);
    }
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
    }
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const btn = document.getElementById('auto-refresh-btn');
    const intervalSelect = document.getElementById('refresh-interval');
    const intervalSeconds = intervalSelect ? parseInt(intervalSelect.value) : 30;
    
    if (autoRefreshEnabled && intervalSeconds > 0) {
        startAutoRefresh();
        btn.innerHTML = `<i class="icon icon-clock"></i> æš‚åœåˆ·æ–° (${intervalSeconds}ç§’)`;
        btn.style.backgroundColor = '';
    } else {
        stopAutoRefresh();
        btn.innerHTML = '<i class="icon icon-clock"></i> å¯åŠ¨åˆ·æ–°';
        btn.style.backgroundColor = '#dc3545';
    }
    
    // ä¿å­˜çŠ¶æ€åˆ°é…ç½®
    const config = {
        log_auto_refresh: intervalSeconds.toString(),
        log_max_lines: maxLines.toString(),
        log_backup_enabled: logBackupEnabled,
        auto_refresh_enabled: autoRefreshEnabled ? "1" : "0"  // æ–°å¢ï¼šä¿å­˜å¼€å…³çŠ¶æ€
    };
    
    saveConfig(config);
}

// ========== ç§»åŠ¨ç«¯é€‚é… ==========
function detectMobile() {
    const container = document.getElementById('log-description-container');
    isMobile = window.innerWidth <= 768;
    
    if (container) {
        if (isMobile) {
            // ç§»åŠ¨ç«¯ç«–æ’æ˜¾ç¤º
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                        <h4 style="margin-top: 0; color: #007bff;"><i class="icon icon-info"></i> æ—¥å¿—ç­‰çº§è¯´æ˜</h4>
                        <div style="font-size: 12px;">
                            <p><span style="color: #9cdcfe;">â–  ä¿¡æ¯</span> - æ™®é€šæ“ä½œè®°å½•</p>
                            <p><span style="color: #6a9955;">âœ… æˆåŠŸ</span> - æ“ä½œæˆåŠŸå®Œæˆ</p>
                            <p><span style="color: #ffcc00;">âš  è­¦å‘Š</span> - éœ€è¦æ³¨æ„çš„æƒ…å†µ</p>
                            <p><span style="color: #f44747;">âŒ é”™è¯¯</span> - é”™è¯¯å’Œå¤±è´¥ä¿¡æ¯</p>
                            <p><span style="color: #ce9178;">â° æ—¶é—´</span> - è§„åˆ™æ—¶é—´ç›¸å…³</p>
                            <p><span style="color: #b5cea8;">ğŸ”• ç¦ç”¨</span> - è§„åˆ™è¢«ç¦ç”¨</p>
                            <p><span style="color: #c586c0;">ğŸ”’ å¼ºåŠ›</span> - å¼ºåŠ›æ§åˆ¶è§„åˆ™</p>
                            <p><span style="color: #569cd6;">ğŸ”— æ™®é€š</span> - æ™®é€šæ§åˆ¶è§„åˆ™</p>
                            <p><span style="color: #4ec9b0;">ğŸ“Š ç»Ÿè®¡</span> - è§„åˆ™ç»Ÿè®¡ä¿¡æ¯</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                        <h4 style="margin-top: 0; color: #28a745;"><i class="icon icon-settings"></i> æ“ä½œè¯´æ˜</h4>
                        <div style="font-size: 12px;">
                            <p><strong>åˆ·æ–°æ—¥å¿—</strong> - é‡æ–°åŠ è½½æœ€æ–°æ—¥å¿—</p>
                            <p><strong>æ¸…ç©ºæ—¥å¿—</strong> - æ¸…ç©ºå½“å‰æ—¥å¿—</p>
                            <p><strong>ä¸‹è½½æ—¥å¿—</strong> - ä¿å­˜æ—¥å¿—åˆ°æœ¬åœ°æ–‡ä»¶</p>
                            <p><strong>ç³»ç»ŸçŠ¶æ€</strong> - æŸ¥çœ‹å½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
                            <p><strong>åŒå‡»æ—¥å¿—åŒº</strong> - åˆ‡æ¢å…¨å±æ˜¾ç¤ºæ¨¡å¼</p>
                            <p><strong>è¿‡æ»¤åŠŸèƒ½</strong> - æŒ‰ç±»å‹ç­›é€‰æ—¥å¿—</p>
                            <p><strong>æ»šåŠ¨æŒ‰é’®</strong> - å¿«é€Ÿè·³è½¬åˆ°é¡¶éƒ¨/åº•éƒ¨</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-top: 0; color: #ffc107;"><i class="icon icon-help-circle"></i> ä½¿ç”¨æç¤º</h4>
                        <div style="font-size: 12px;">
                            <p>â€¢ æ—¥å¿—æ–‡ä»¶: <code>/var/log/znetcontrol.log</code></p>
                            <p>â€¢ è‡ªåŠ¨åˆ·æ–°: å¯é…ç½®é—´éš”æ—¶é—´</p>
                            <p>â€¢ æœ€å¤§æ˜¾ç¤º: å¯é…ç½®æ˜¾ç¤ºè¡Œæ•°</p>
                            <p>â€¢ å¤‡ä»½æ¨¡å¼: æ¸…ç©ºæ—¥å¿—æ—¶è‡ªåŠ¨å¤‡ä»½</p>
                            <p>â€¢ é”®ç›˜å¿«æ·é”®: Ctrl+R åˆ·æ–°, Ctrl+D ä¸‹è½½</p>
                            <p>â€¢ æ”¯æŒæŒ‰ç±»å‹è¿‡æ»¤: ä¿¡æ¯ã€æˆåŠŸã€è­¦å‘Šã€é”™è¯¯ç­‰</p>
                            <p>â€¢ æ—¥å¿—è¡¨æƒ…è¯´æ˜:</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <span style="color: #6a9955;">âœ… æˆåŠŸ</span>
                                <span style="color: #ffcc00;">âš  è­¦å‘Š</span>
                                <span style="color: #f44747;">âŒ é”™è¯¯</span>
                                <span style="color: #ce9178;">â° æ—¶é—´</span>
                                <span style="color: #b5cea8;">ğŸ”• ç¦ç”¨</span>
                                <span style="color: #c586c0;">ğŸ”’ å¼ºåŠ›</span>
                                <span style="color: #569cd6;">ğŸ”— æ™®é€š</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // PCç«¯æ¨ªæ’æ˜¾ç¤º
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 15px; width: 100%;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;">
                        <h4 style="margin-top: 0; color: #007bff;"><i class="icon icon-info"></i> æ—¥å¿—ç­‰çº§è¯´æ˜</h4>
                        <div style="font-size: 12px; display: flex; flex-direction: column; gap: 5px;">
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #9cdcfe; margin-right: 5px; flex-shrink: 0;">â– </span>
                                <strong style="margin-right: 5px;">ä¿¡æ¯</strong> - æ™®é€šæ“ä½œè®°å½•
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #6a9955; margin-right: 5px; flex-shrink: 0;">âœ…</span>
                                <strong style="margin-right: 5px;">æˆåŠŸ</strong> - æ“ä½œæˆåŠŸå®Œæˆ
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #ffcc00; margin-right: 5px; flex-shrink: 0;">âš </span>
                                <strong style="margin-right: 5px;">è­¦å‘Š</strong> - éœ€è¦æ³¨æ„çš„æƒ…å†µ
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #f44747; margin-right: 5px; flex-shrink: 0;">âŒ</span>
                                <strong style="margin-right: 5px;">é”™è¯¯</strong> - é”™è¯¯å’Œå¤±è´¥ä¿¡æ¯
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #ce9178; margin-right: 5px; flex-shrink: 0;">â°</span>
                                <strong style="margin-right: 5px;">æ—¶é—´</strong> - è§„åˆ™æ—¶é—´ç›¸å…³
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #b5cea8; margin-right: 5px; flex-shrink: 0;">ğŸ”•</span>
                                <strong style="margin-right: 5px;">ç¦ç”¨</strong> - è§„åˆ™è¢«ç¦ç”¨
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #c586c0; margin-right: 5px; flex-shrink: 0;">ğŸ”’</span>
                                <strong style="margin-right: 5px;">å¼ºåŠ›</strong> - å¼ºåŠ›æ§åˆ¶è§„åˆ™
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #569cd6; margin-right: 5px; flex-shrink: 0;">ğŸ”—</span>
                                <strong style="margin-right: 5px;">æ™®é€š</strong> - æ™®é€šæ§åˆ¶è§„åˆ™
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; min-height: 20px;">
                                <span style="color: #4ec9b0; margin-right: 5px; flex-shrink: 0;">ğŸ“Š</span>
                                <strong style="margin-right: 5px;">ç»Ÿè®¡</strong> - è§„åˆ™ç»Ÿè®¡ä¿¡æ¯
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                        <h4 style="margin-top: 0; color: #28a745;"><i class="icon icon-settings"></i> æ“ä½œè¯´æ˜</h4>
                        <div style="font-size: 12px; display: flex; flex-direction: column; gap: 5px;">
                            <p style="margin: 0;"><strong>åˆ·æ–°æ—¥å¿—</strong> - é‡æ–°åŠ è½½æœ€æ–°æ—¥å¿—</p>
                            <p style="margin: 0;"><strong>æ¸…ç©ºæ—¥å¿—</strong> - æ¸…ç©ºå½“å‰æ—¥å¿—</p>
                            <p style="margin: 0;"><strong>ä¸‹è½½æ—¥å¿—</strong> - ä¿å­˜æ—¥å¿—åˆ°æœ¬åœ°æ–‡ä»¶</p>
                            <p style="margin: 0;"><strong>ç³»ç»ŸçŠ¶æ€</strong> - æŸ¥çœ‹å½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
                            <p style="margin: 0;"><strong>åŒå‡»æ—¥å¿—åŒº</strong> - åˆ‡æ¢å…¨å±æ˜¾ç¤ºæ¨¡å¼</p>
                            <p style="margin: 0;"><strong>è¿‡æ»¤åŠŸèƒ½</strong> - æŒ‰ç±»å‹ç­›é€‰æ—¥å¿—</p>
                            <p style="margin: 0;"><strong>æ»šåŠ¨æŒ‰é’®</strong> - å¿«é€Ÿè·³è½¬åˆ°é¡¶éƒ¨/åº•éƒ¨</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-top: 0; color: #ffc107;"><i class="icon icon-help-circle"></i> ä½¿ç”¨æç¤º</h4>
                        <div style="font-size: 12px; display: flex; flex-direction: column; gap: 5px;">
                            <p style="margin: 0;">â€¢ æ—¥å¿—æ–‡ä»¶: <code>/var/log/znetcontrol.log</code></p>
                            <p style="margin: 0;">â€¢ è‡ªåŠ¨åˆ·æ–°: å¯é…ç½®é—´éš”æ—¶é—´</p>
                            <p style="margin: 0;">â€¢ æœ€å¤§æ˜¾ç¤º: å¯é…ç½®æ˜¾ç¤ºè¡Œæ•°</p>
                            <p style="margin: 0;">â€¢ å¤‡ä»½æ¨¡å¼: æ¸…ç©ºæ—¥å¿—æ—¶è‡ªåŠ¨å¤‡ä»½</p>
                            <p style="margin: 0;">â€¢ é”®ç›˜å¿«æ·é”®: Ctrl+R åˆ·æ–°, Ctrl+D ä¸‹è½½</p>
                            <p style="margin: 0;">â€¢ æ”¯æŒæŒ‰ç±»å‹è¿‡æ»¤: ä¿¡æ¯ã€æˆåŠŸã€è­¦å‘Šã€é”™è¯¯ç­‰</p>
                            <div style="margin-top: 5px;">
                                <p style="margin: 0 0 3px 0; font-weight: bold;">æ—¥å¿—è¡¨æƒ…è¯´æ˜:</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    <span style="color: #6a9955;">âœ… æˆåŠŸ</span>
                                    <span style="color: #ffcc00;">âš  è­¦å‘Š</span>
                                    <span style="color: #f44747;">âŒ é”™è¯¯</span>
                                    <span style="color: #ce9178;">â° æ—¶é—´</span>
                                    <span style="color: #b5cea8;">ğŸ”• ç¦ç”¨</span>
                                    <span style="color: #c586c0;">ğŸ”’ å¼ºåŠ›</span>
                                    <span style="color: #569cd6;">ğŸ”— æ™®é€š</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    const floatButtons = document.getElementById('mobile-float-buttons');
    const logContent = document.getElementById('log-content');
    
    if (isMobile) {
        if (floatButtons) floatButtons.style.display = 'block';
        if (logContent) logContent.style.height = 'calc(100vh - 350px)';
    } else {
        if (floatButtons) floatButtons.style.display = 'none';
        if (logContent) logContent.style.height = '500px';
    }
}

// ========== åˆå§‹åŒ– ==========
window.addEventListener('load', function() {
    // åŠ è½½æ—¥å¿—è®¾ç½®
    loadLogSettings().then(() => {
        // åŠ è½½å…¶ä»–é…ç½®
        return loadConfig();
    }).then(config => {
        console.log('é…ç½®åŠ è½½å®Œæˆ:', config);
        
        // åˆå§‹åŒ–æ—¥å¿—è¯´æ˜
        detectMobile();
        
        // åŠ è½½æ—¥å¿—
        refreshLogs();
        
        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        if (config.log_auto_refresh && config.log_auto_refresh !== '0') {
            autoRefreshIntervalMs = parseInt(config.log_auto_refresh) * 1000;
            startAutoRefresh();
        } else {
            // ä¸è‡ªåŠ¨åˆ·æ–°
            autoRefreshEnabled = false;
            const btn = document.getElementById('auto-refresh-btn');
            if (btn) {
                btn.innerHTML = '<i class="icon icon-clock"></i> è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨';
                btn.style.backgroundColor = '#6c757d';
            }
        }
    });
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', detectMobile);
    
    // åŒå‡»å…¨å±
    const logElement = document.getElementById('log-content');
    if (logElement) {
        logElement.addEventListener('dblclick', toggleFullscreen);
    }
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            refreshLogs();
        }
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            downloadLogs();
        }
        if (e.key === 'Escape') {
            document.getElementById('system-status').style.display = 'none';
        }
    });
});

// æ¸…ç†
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// æ·»åŠ CSSæ ·å¼
const style = document.createElement('style');
style.textContent = `
/* è¦†ç›–cbi-sectionçš„å®½åº¦é™åˆ¶ */
.cbi-section .cbi-value-field {
    width: 100% !important;
    max-width: none !important;
}

/* ç¡®ä¿å®¹å™¨ä½¿ç”¨å…¨å®½ */
#log-description-container > div {
    width: 100% !important;
    box-sizing: border-box;
}

/* ç¡®ä¿å†…éƒ¨å†…å®¹ä¸æº¢å‡º */
#log-description-container > div > div {
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* æ—¥å¿—åŒºåŸŸæ»šåŠ¨æ¡æ ·å¼ */
#log-content::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}
#log-content::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 5px;
}
#log-content::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 5px;
}
#log-content::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* æŒ‰é’®æ ·å¼ */
.cbi-button {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid transparent;
    cursor: pointer;
    font-size: 13px;
}
.cbi-button-action {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
.cbi-button-reset {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}
.cbi-button-apply {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}
.cbi-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

fieldset.cbi-section {
    width: 90% !important;
    max-width: none !important;
}

.cbi-value {
    width: 90% !important;
}

.cbi-value-field {
    width: 90% !important;
    max-width: 100% !important;
    display: block !important;
}

#log-description-container {
    width: 90% !important;
    display: block !important;
}

/* é€‰æ‹©æ¡†æ ·å¼ */
select {
    background-color: white;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 13px;
    color: #495057;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    #log-description-container > div {
        flex-direction: column;
    }
    
    #log-description-container > div > div {
        width: 100% !important;
    }
    
    .log-toolbar > div:last-child {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .log-toolbar select {
        width: 100%;
        margin-bottom: 5px;
    }
}
`;
document.head.appendChild(style);
</script>
<%+footer%>

