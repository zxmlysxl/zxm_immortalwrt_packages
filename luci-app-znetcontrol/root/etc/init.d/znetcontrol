#!/bin/sh
# ZNetControl init.d 脚本 - 完整版

START=99
STOP=10
PID_FILE="/var/run/znetcontrol.pid"
DAEMON="/usr/bin/znetcontrol.sh"
NAME="znetcontrol"
DESC="ZNetControl Internet Access Control"

# ========== 修复：彻底清理所有相关进程 ==========
kill_all_processes() {
    # 杀死所有znetcontrol相关进程
    pkill -f "znetcontrol.sh daemon" >/dev/null 2>&1
    pkill -f "znetcontrol.sh" >/dev/null 2>&1
    
    # 等待进程退出
    sleep 1
    
    # 强制杀死残留进程
    pgrep -f "znetcontrol.sh" | xargs kill -9 >/dev/null 2>&1
    
    # 清理PID文件
    rm -f "$PID_FILE"
}

start() {
    echo "Starting $DESC..."
    
    # 先彻底清理旧进程
    kill_all_processes
    
    # 启动服务
    $DAEMON daemon
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        echo "Started $DESC (PID: $pid)"
        return 0
    else
        echo "Failed to start $DESC"
        return 1
    fi
}

stop() {
    echo "Stopping $DESC..."
    
    # 彻底清理所有进程
    kill_all_processes
    
    echo "Stopped $DESC"
    return 0
}

restart() {
    echo "Restarting $DESC..."
    stop
    sleep 3
    start
}

status() {
    # 修复：强制刷新PID文件后再调用status
    local running_pid=$(pgrep -f "znetcontrol.sh daemon" | head -1)
    if [ -n "$running_pid" ]; then
        echo "$running_pid" > "$PID_FILE"
    fi
    $DAEMON status
    return $?
}


reload() {
    echo "Reloading $DESC rules..."
    $DAEMON reload
    return $?
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    status)
        status
        ;;
    enable)
        ln -sf /etc/init.d/$NAME /etc/rc.d/S99$NAME 2>/dev/null
        ln -sf /etc/init.d/$NAME /etc/rc.d/K10$NAME 2>/dev/null
        echo "Enabled $DESC"
        ;;
    disable)
        rm -f /etc/rc.d/*$NAME* 2>/dev/null
        echo "Disabled $DESC"
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status|enable|disable}"
        exit 1
        ;;
esac

exit 0

