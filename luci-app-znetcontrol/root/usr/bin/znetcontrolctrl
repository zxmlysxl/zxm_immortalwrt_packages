#!/bin/sh

# åŸºäºtimecontrolctrlçš„ZNetControlç›‘æ§ç¨‹åº

NAME=znetcontrol
IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"

# è·å–å¯ç”¨è§„åˆ™çš„ID
get_enabled_rule_ids() {
    local rule_ids=""
    local index=0
    
    # æ£€æŸ¥æ–°çš„deviceæ®µ
    while true; do
        local enable_val=$(uci -q get znetcontrol.@device[$index].enable)
        local target_val=$(uci -q get znetcontrol.@device[$index].target)
        
        if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
            break
        fi
        
        if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
            rule_ids="$rule_ids $index"
        fi
        
        index=$((index + 1))
    done
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€æŸ¥æ—§çš„ruleæ®µ
    if [ -z "$rule_ids" ]; then
        index=0
        while true; do
            local enable_val=$(uci -q get znetcontrol.@rule[$index].enabled)
            local target_val=$(uci -q get znetcontrol.@rule[$index].target)
            
            if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                break
            fi
            
            if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                rule_ids="$rule_ids $index"
            fi
            
            index=$((index + 1))
        done
    fi
    
    echo $rule_ids
}

config_t_get() {
    local index=${3:-0}
    local ret=$(uci -q get "${NAME}.@${1}[${index}].${2}")
    echo "${ret:=${4}}"
}

is_time_in_range() {
    local start_time=$1
    local end_time=$2
    local current_time=$(date +%H:%M)

    if [ "$start_time" = "$end_time" ]; then
        return 0 
    elif [ "$start_time" \< "$end_time" ]; then
        [ "$current_time" \> "$start_time" ] && [ "$current_time" \< "$end_time" ] && return 0
    else
        [ "$current_time" \> "$start_time" ] || [ "$current_time" \< "$end_time" ] && return 0
    fi
    return 1
}

is_weekday_in_range() {
    local configured_weekdays=$1
    local current_weekday=$(date +%u)

    for ww in $(echo $configured_weekdays | sed 's/,/ /g'); do
        if [ "$current_weekday" = "$ww" ] || [ "$ww" = "0" ]; then
            return 0
        fi
    done
    return 1
}

check_device() {
    local id=$1
    local start_time=$(config_t_get device timestart $id)
    local end_time=$(config_t_get device timeend $id)
    local weekdays=$(config_t_get device week $id)

    if is_weekday_in_range "$weekdays" && is_time_in_range "$start_time" "$end_time"; then
        return 0  
    else
        return 1 
    fi
}

update_device_status() {
    local id=$1
    local action=$2
    
    # è·å–è§„åˆ™è¯¦ç»†ä¿¡æ¯
    local name=$(config_t_get device name $id)
    local target=$(config_t_get device target $id)
    local chain=$(config_t_get device chain $id "forward")
    
    # ä½¿ç”¨è§„åˆ™åç§°æˆ–ç›®æ ‡åœ°å€
    local display_name="$name"
    if [ -z "$display_name" ] || [ "$display_name" = "æ–°è§„åˆ™" ]; then
        display_name="$target"
    fi
    
    if [ "$action" = "add" ]; then
        info "æ·»åŠ è§„åˆ™ã€$display_nameã€‘åˆ°æ§åˆ¶åˆ—è¡¨"
        znetcontrol add $id
        
        # è¿™é‡Œåªè®°å½•ï¼Œä¸æ·»åŠ åˆ°IDLISTï¼ˆç”±ä¸»è„šæœ¬å¤„ç†ï¼‰
        echo "!${id}!" >> $IDLIST
        
        # è®°å½•æ§åˆ¶å¼ºåº¦
        if [ "$chain" = "input" ]; then
            info "ğŸ”’ è§„åˆ™ã€$display_nameã€‘ä½¿ç”¨å¼ºåŠ›æ§åˆ¶ï¼ˆINPUT+FORWARDï¼‰"
        else
            info "ğŸ”— è§„åˆ™ã€$display_nameã€‘ä½¿ç”¨æ™®é€šæ§åˆ¶ï¼ˆFORWARDï¼‰"
        fi
    elif [ "$action" = "del" ]; then
        info "ä»æ§åˆ¶åˆ—è¡¨ç§»é™¤è§„åˆ™ã€$display_nameã€‘"
        znetcontrol del $id
        sed -i "/!$id!/d" $IDLIST >/dev/null 2>&1
    fi
}

process_devices() {
    [ -s $IDLIST ] || touch $IDLIST
    
    info "å¼€å§‹æ£€æŸ¥è®¾å¤‡è§„åˆ™..."
    
    for id in $(get_enabled_rule_ids); do
        info "æ£€æŸ¥è§„åˆ™ $id"
        if check_device $id; then
            info "è§„åˆ™ $id åœ¨ç”Ÿæ•ˆæ—¶é—´å†…"
            if ! grep -q "!${id}!" $IDLIST; then
                info "æ·»åŠ è§„åˆ™ $id åˆ°é˜²ç«å¢™"
                update_device_status $id "add"
            else
                info "è§„åˆ™ $id å·²åœ¨é˜²ç«å¢™ä¸­"
            fi
        else
            info "è§„åˆ™ $id ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´å†…"
            if grep -q "!${id}!" $IDLIST; then
                info "ä»é˜²ç«å¢™ç§»é™¤è§„åˆ™ $id"
                update_device_status $id "del"
            fi
        fi
    done

    cat $IDLIST | sort | uniq > $TMPID 2>/dev/null
    mv $TMPID $IDLIST 2>/dev/null
    
    info "å½“å‰é˜²ç«å¢™ä¸­çš„è§„åˆ™: $(cat $IDLIST 2>/dev/null | wc -l) ä¸ª"
}

while :; do
    process_devices
    sleep 60
done

