#!/bin/bash

NAME=znetcontrol
IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"

get_rule_name() {
    local id=$1
    local name=$(uci -q get znetcontrol.@device[$id].name)
    if [ -z "$name" ] || [ "$name" = "新规则" ]; then
        name=$(uci -q get znetcontrol.@device[$id].target)
        if [ -z "$name" ]; then
            name="规则$id"
        fi
    fi
    echo "$name"
}

get_enabled_rule_ids() {
    local rule_ids=""
    local index=0
    
    while true; do
        local enable_val=$(uci -q get "znetcontrol.@device[$index].enable")
        local target_val=$(uci -q get "znetcontrol.@device[$index].target")
        
        if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
            break
        fi
        
        if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
            rule_ids="$rule_ids $index"
        fi
        
        index=$((index + 1))
    done
    
    echo $rule_ids
}

config_t_get() {
    local section=$1
    local option=$2
    local index=${3:-0}
    
    local value=$(uci -q get "znetcontrol.@${section}[${index}].${option}")
    echo "$value"
}

# 使用数值计算的时间判断函数
is_time_in_range() {
    local start_time=$1
    local end_time=$2
    
    # 处理空值
    start_time=${start_time:-00:00}
    end_time=${end_time:-23:59}
    
    # 获取当前时间
    local current_hour=$(date +%H)
    local current_minute=$(date +%M)
    local current_total=$((10#$current_hour * 60 + 10#$current_minute))
    
    # 转换开始时间
    local start_hour=${start_time%:*}
    local start_minute=${start_time#*:}
    local start_total=$((10#$start_hour * 60 + 10#$start_minute))
    
    # 转换结束时间
    local end_hour=${end_time%:*}
    local end_minute=${end_time#*:}
    local end_total=$((10#$end_hour * 60 + 10#$end_minute))
    
    # 如果是全天
    if [ "$start_time" = "$end_time" ]; then
        return 0  # 全天生效
    elif [ $start_total -lt $end_total ]; then
        # 正常时间段（不跨天）
        # 包含开始时间，不包含结束时间
        [ $current_total -ge $start_total ] && [ $current_total -lt $end_total ] && return 0
    else
        # 跨天时间段
        [ $current_total -ge $start_total ] || [ $current_total -lt $end_total ] && return 0
    fi
    
    return 1
}

is_weekday_in_range() {
    local configured_weekdays=$1
    local current_weekday=$(date +%u)  # 1=星期一, 7=星期日
    
    # 如果配置为"0"，表示每天
    [ "$configured_weekdays" = "0" ] && return 0
    
    # 检查逗号分隔的列表
    for ww in $(echo $configured_weekdays | tr ',' ' '); do
        [ "$current_weekday" = "$ww" ] && return 0
    done
    
    return 1
}

check_device() {
    local id=$1
    local start_time=$(config_t_get device timestart $id)
    local end_time=$(config_t_get device timeend $id)
    local weekdays=$(config_t_get device week $id)
    local enable_val=$(config_t_get device enable $id)
    
    # 检查是否启用
    [ "$enable_val" != "1" ] && return 1
    
    # 检查星期和时间
    is_weekday_in_range "$weekdays" && is_time_in_range "$start_time" "$end_time"
}

update_device_status() {
    local id=$1
    local action=$2
    
    local rule_name=$(get_rule_name $id)
    
    if [ "$action" = "add" ]; then
        znetcontrol add $id
        echo "!${id}!" >> $IDLIST
        logger -t znetcontrol "【$rule_name】已添加到防火墙"
    elif [ "$action" = "del" ]; then
        znetcontrol del $id
        sed -i "/!$id!/d" $IDLIST >/dev/null 2>&1
        logger -t znetcontrol "【$rule_name】已从防火墙移除"
    fi
}

process_devices() {
    [ -s $IDLIST ] || touch $IDLIST
    
    log "开始检查设备规则..."
    
    # 获取当前启用的规则ID
    local enabled_ids=$(get_enabled_rule_ids)
    
    for id in $enabled_ids; do
        local rule_name=$(get_rule_name $id)
        
        if check_device $id; then
            log "【$rule_name】在生效时间内"
            if ! grep -q "!${id}!" $IDLIST; then
                log "添加【$rule_name】到防火墙"
                update_device_status $id "add"
            fi
        else
            log "【$rule_name】不在生效时间内"
            if grep -q "!${id}!" $IDLIST; then
                log "从防火墙移除【$rule_name】"
                update_device_status $id "del"
            fi
        fi
    done

    # 清理并排序ID列表
    cat $IDLIST 2>/dev/null | sort | uniq > $TMPID 2>/dev/null
    [ -f $TMPID ] && mv $TMPID $IDLIST 2>/dev/null
    
    log "当前防火墙中的规则: $(cat $IDLIST 2>/dev/null | wc -l) 个"
}

log() {
    local d="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$d] INFO: $@" >>/var/log/znetcontrol.log
}

while :; do
    process_devices
    sleep 30
done
