#!/bin/sh

NAME=znetcontrol
IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"

# 获取规则名称的辅助函数
get_rule_name() {
    local id=$1
    local name=$(uci -q get znetcontrol.@device[$id].name)
    if [ -z "$name" ] || [ "$name" = "新规则" ]; then
        name=$(uci -q get znetcontrol.@device[$id].target)
        if [ -z "$name" ]; then
            name="规则$id"
        fi
    fi
    echo "$name"
}

# 获取启用规则的ID
get_enabled_rule_ids() {
    local rule_ids=""
    local index=0
    
    # 检查新的device段
    while true; do
        local enable_val=$(uci -q get znetcontrol.@device[$index].enable)
        local target_val=$(uci -q get znetcontrol.@device[$index].target)
        
        if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
            break
        fi
        
        if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
            rule_ids="$rule_ids $index"
        fi
        
        index=$((index + 1))
    done
    
    # 如果没有找到，检查旧的rule段
    if [ -z "$rule_ids" ]; then
        index=0
        while true; do
            local enable_val=$(uci -q get znetcontrol.@rule[$index].enabled)
            local target_val=$(uci -q get znetcontrol.@rule[$index].target)
            
            if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                break
            fi
            
            if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                rule_ids="$rule_ids $index"
            fi
            
            index=$((index + 1))
        done
    fi
    
    echo $rule_ids
}

config_t_get() {
    local index=${3:-0}
    local ret=$(uci -q get "${NAME}.@${1}[${index}].${2}")
    echo "${ret:=${4}}"
}

is_time_in_range() {
    local start_time=$1
    local end_time=$2
    local current_time=$(date +%H:%M)

    if [ "$start_time" = "$end_time" ]; then
        return 0 
    elif [ "$start_time" \< "$end_time" ]; then
        [ "$current_time" \> "$start_time" ] && [ "$current_time" \< "$end_time" ] && return 0
    else
        [ "$current_time" \> "$start_time" ] || [ "$current_time" \< "$end_time" ] && return 0
    fi
    return 1
}

is_weekday_in_range() {
    local configured_weekdays=$1
    local current_weekday=$(date +%u)

    for ww in $(echo $configured_weekdays | sed 's/,/ /g'); do
        if [ "$current_weekday" = "$ww" ] || [ "$ww" = "0" ]; then
            return 0
        fi
    done
    return 1
}

check_device() {
    local id=$1
    local start_time=$(config_t_get device timestart $id)
    local end_time=$(config_t_get device timeend $id)
    local weekdays=$(config_t_get device week $id)

    if is_weekday_in_range "$weekdays" && is_time_in_range "$start_time" "$end_time"; then
        return 0  
    else
        return 1 
    fi
}

update_device_status() {
    local id=$1
    local action=$2
    
    # 获取规则名称
    local rule_name=$(get_rule_name $id)
    
    if [ "$action" = "add" ]; then
        znetcontrol add $id
        echo "!${id}!" >> $IDLIST
        logger -t znetcontrol "【$rule_name】已添加到防火墙"
    elif [ "$action" = "del" ]; then
        znetcontrol del $id
        sed -i "/!$id!/d" $IDLIST >/dev/null 2>&1
        logger -t znetcontrol "【$rule_name】已从防火墙移除"
    fi
}

process_devices() {
    [ -s $IDLIST ] || touch $IDLIST
    
    info "开始检查设备规则..."
    
    for id in $(get_enabled_rule_ids); do
        local rule_name=$(get_rule_name $id)
        info "检查【$rule_name】(ID: $id)"
        
        if check_device $id; then
            info "【$rule_name】在生效时间内"
            if ! grep -q "!${id}!" $IDLIST; then
                info "添加【$rule_name】到防火墙"
                update_device_status $id "add"
            else
                info "【$rule_name】已在防火墙中"
            fi
        else
            info "【$rule_name】不在生效时间内"
            if grep -q "!${id}!" $IDLIST; then
                info "从防火墙移除【$rule_name】"
                update_device_status $id "del"
            fi
        fi
    done

    cat $IDLIST | sort | uniq > $TMPID 2>/dev/null
    mv $TMPID $IDLIST 2>/dev/null
    
    info "当前防火墙中的规则: $(cat $IDLIST 2>/dev/null | wc -l) 个"
}

# 日志函数
log() {
    local d="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$d] $@" >>/var/log/znetcontrol.log
}

info() {
    log "INFO: $@"
}

while :; do
    process_devices
    sleep 60
done
