#!/bin/bash

crrun=$1
crid=$2
NAME=znetcontrol
DEBUG=0

NFT_TABLE="inet $NAME"
LOG_FILE="/var/log/$NAME.log"
CONFIG_FILE="/etc/config/$NAME"

config_get_type() {
    local ret=$(uci -q get "${NAME}.${1}")
    echo "${ret:=$2}"
}

config_n_get() {
    local ret=$(uci -q get "${NAME}.${1}.${2}")
    echo "${ret:=$3}"
}

config_t_get() {
    local index=${3:-0}
    local default=$4
    local ret=$(uci -q get "${NAME}.@${1}[${index}].${2}")
    echo "${ret:-$default}"
}

config_t_set() {
    local index=${4:-0}
    local ret=$(uci -q set "${NAME}.@${1}[${index}].${2}=${3}")
}

IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"
list_type=$(config_t_get settings control_mode 0 "blacklist")
CHAIN=$(config_t_get settings chain 0 "forward")

bin_nft=$(which nft 2>/dev/null)
bin_iptables=$(which iptables 2>/dev/null)
bin_ip6tables=$(which ip6tables 2>/dev/null)
bin_conntrack=$(which conntrack 2>/dev/null)

is_input_chain() {
    [ "$CHAIN" = "input" ]
}

log() {
    local d="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$d] $@" >>$LOG_FILE
}

info() {
    log "INFO: $@"
}

dbg() {
    [ "$DEBUG" -eq 1 ] && log "DEBUG: $@"
}

parse_target() {
    local target="$1"
    
    target=$(echo "${target}" | xargs)
    
    # å•ä¸ªIPåœ°å€
    if echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local octets=(${target//./ })
        for octet in "${octets[@]}"; do
            [ "$octet" -le 255 ] || return 1
        done
        echo "ipv4:single:${target}"
        return 0
    
    # IPèŒƒå›´
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}-([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local start_ip=${target%-*}
        local end_ip=${target#*-}
        
        local start_octets=(${start_ip//./ })
        local end_octets=(${end_ip//./ })
        for i in {0..3}; do
            [ "${start_octets[$i]}" -le 255 ] && [ "${end_octets[$i]}" -le 255 ] || return 1
        done
        
        echo "ipv4:range:${target}"
        return 0
    
    # CIDRæ ¼å¼
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$'; then
        local ip=${target%/*}
        local mask=${target#*/}
        
        if [ "$mask" -ge 0 ] && [ "$mask" -le 32 ]; then
            local octets=(${ip//./ })
            for octet in "${octets[@]}"; do
                [ "$octet" -le 255 ] || return 1
            done
            echo "ipv4:cidr:${target}"
            return 0
        fi
    
    # MACåœ°å€
    elif echo "$target" | grep -qE '^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$'; then
        echo "mac:single:${target,,}"
        return 0
    
    # IPv6åœ°å€
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$'; then
        echo "ipv6:single:${target}"
        return 0
    
    # IPv6 CIDR
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}/[0-9]{1,3}$'; then
        local ipv6=${target%/*}
        local mask=${target#*/}
        if [ "$mask" -ge 0 ] && [ "$mask" -le 128 ]; then
            echo "ipv6:cidr:${target}"
            return 0
        fi
    fi
    
    return 1
}

convert_to_old_format() {
    local target="$1"
    local parsed_result=$(parse_target "$target")
    [ $? -ne 0 ] && return 1
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    case "$type" in
        "ipv4")
            case "$subtype" in
                "single") 
                    echo "ip ipv4_addr $value"
                    ;;
                "range")
                    local start_ip=${value%-*}
                    local end_ip=${value#*-}
                    echo "ip ipv4_addr { $start_ip-$end_ip }"
                    ;;
                "cidr")
                    echo "ip ipv4_addr $value"
                    ;;
            esac
            ;;
        "mac")
            echo "bridge ether_addr $value"
            ;;
        "ipv6")
            case "$subtype" in
                "single") echo "ip6 ipv6_addr $value" ;;
                "cidr") echo "ip6 ipv6_addr $value" ;;
            esac
            ;;
    esac
}

flush_connections() {
    local target="$1"
    
    if [ -x "$bin_conntrack" ]; then
        local parsed_result=$(parse_target "${target}")
        if [ $? -eq 0 ]; then
            IFS=':' read -r type subtype value <<< "${parsed_result}"
            
            case "${type}" in
                "ipv4")
                    case "$subtype" in
                        "single")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†IPè¿æ¥: ${value}"
                            ;;
                        "cidr")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†CIDRè¿æ¥: ${value}"
                            ;;
                    esac
                    info "æ–­å¼€è¿æ¥: ${target}"
                    ;;
                "mac")
                    if [ -f "/proc/net/arp" ]; then
                        local ip_addr=$(grep -i "${value}" /proc/net/arp 2>/dev/null | awk '{print $1}' | head -1)
                        if [ -n "${ip_addr}" ]; then
                            $bin_conntrack -D -s "${ip_addr}" 2>/dev/null || true
                            $bin_conntrack -D -d "${ip_addr}" 2>/dev/null || true
                            dbg "æ¸…ç†MACè¿æ¥: ${value} (IP: ${ip_addr})"
                            info "æ–­å¼€MACè¿æ¥: ${value}"
                        fi
                    fi
                    ;;
            esac
        else
            dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: ${target}"
        fi
    else
        dbg "conntrackæœªå®‰è£…"
    fi
}

nft_table_exists() {
    local table=$1
    nft list tables | grep -q "$table"
}

nft_set_exists() {
    local table=$1
    local set=$2
    nft list sets | grep -q "$table $set"
}

stop_timecontrol() {
    if [ -n "$nftables_ver" ]; then
        nft delete table $NFT_TABLE 2>/dev/null && info "å·²æ¸…ç†nftablesè§„åˆ™"
    fi

    rm -rf  "$IDLIST" "$TMPID" 2>/dev/null
}

init_timecontrol() {
    info "åˆå§‹åŒ–æ—¶é—´æ§åˆ¶"
    
    if [ -n "$nftables_ver" ]; then
        # ç¡®ä¿æ¸…ç†æ—§çš„è¡¨
        nft delete table inet znetcontrol 2>/dev/null || true
        
        # åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„inetè¡¨
        nft add table inet znetcontrol
        dbg "åˆ›å»ºè¡¨ inet znetcontrol"
        
        # åªåˆ›å»ºé»‘åå•é›†åˆï¼ˆç§»é™¤äº†ç™½åå•ç›¸å…³ï¼‰
        nft add set inet znetcontrol blacklist_list "{ type ether_addr; flags interval; }" 2>/dev/null || true
        nft add set inet znetcontrol blacklist_ip "{ type ipv4_addr; flags interval; }" 2>/dev/null || true
        
        # åˆ›å»ºINPUTé“¾ï¼ˆç”¨äºå¼ºåŠ›æ§åˆ¶ï¼‰
        nft add chain inet znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        nft add rule inet znetcontrol input ether saddr @blacklist_list drop comment "å¼ºåŠ›æ§åˆ¶ï¼šé˜»æ­¢MACè®¿é—®è·¯ç”±å™¨å’Œç½‘ç»œ"
        nft add rule inet znetcontrol input ip saddr @blacklist_ip drop comment "å¼ºåŠ›æ§åˆ¶ï¼šé˜»æ­¢IPè®¿é—®è·¯ç”±å™¨å’Œç½‘ç»œ"
        dbg "åˆ›å»ºINPUTé“¾ï¼ˆå¼ºåŠ›æ§åˆ¶ï¼‰"
        
        # åˆ›å»ºFORWARDé“¾ï¼ˆç”¨äºæ™®é€šæ§åˆ¶ï¼‰
        nft add chain inet znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        nft add rule inet znetcontrol forward ether saddr @blacklist_list drop comment "æ™®é€šæ§åˆ¶ï¼šé˜»æ­¢MACä¸Šç½‘"
        nft add rule inet znetcontrol forward ip saddr @blacklist_ip drop comment "æ™®é€šæ§åˆ¶ï¼šé˜»æ­¢IPä¸Šç½‘"
        dbg "åˆ›å»ºFORWARDé“¾ï¼ˆæ™®é€šæ§åˆ¶ï¼‰"
        
        info "nftablesè§„åˆ™åˆå§‹åŒ–å®Œæˆï¼Œæ§åˆ¶æ¨¡å¼ï¼šé»‘åå•æ¨¡å¼"
    fi
    
    info "åˆå§‹åŒ–å®Œæˆ"
}

timeadd() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local name=$(config_t_get device name "$id")
    local chain=$(config_t_get device chain "$id" "forward")
    [ -z "$target" ] && return
    
    # ä½¿ç”¨è§„åˆ™åç§°æˆ–ç›®æ ‡åœ°å€
    local display_name="$name"
    if [ -z "$display_name" ] || [ "$display_name" = "æ–°è§„åˆ™" ]; then
        display_name="$target"
    fi
    
    info "æ·»åŠ è®¾å¤‡æ§åˆ¶: $display_name ($target)ï¼Œæ§åˆ¶å¼ºåº¦: $chain"
    
    # è§£æç›®æ ‡ç±»å‹
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    if [ -n "$nftables_ver" ]; then
        case "$type" in
            "mac")
                # æ·»åŠ MACåœ°å€åˆ°é»‘åå•é›†åˆ
                nft add element inet znetcontrol "blacklist_list" "{ $value }"
                info "âœ… æˆåŠŸæ·»åŠ MACåˆ°é»‘åå•: $value"
                ;;
            "ipv4")
                # æ·»åŠ IPåœ°å€åˆ°é»‘åå•IPé›†åˆ
                case "$subtype" in
                    "single"|"range"|"cidr")
                        nft add element inet znetcontrol "blacklist_ip" "{ $value }"
                        info "âœ… æˆåŠŸæ·»åŠ IPåˆ°é»‘åå•: $value"
                        ;;
                esac
                ;;
        esac
    fi
    
    # åº”ç”¨æ§åˆ¶å¼ºåº¦
    if [ "$chain" = "input" ]; then
        # å¼ºåŠ›æ§åˆ¶ï¼šæ–­å¼€ç°æœ‰è¿æ¥
        flush_connections "$target"
        
        # ç¡®ä¿INPUTé“¾è§„åˆ™æ¿€æ´»
        nft add rule inet znetcontrol input ether saddr "{ $value }" drop 2>/dev/null || true
        nft add rule inet znetcontrol forward ether saddr "{ $value }" drop 2>/dev/null || true
        
        info "ğŸ”’ è§„åˆ™ã€$display_nameã€‘å·²åº”ç”¨å¼ºåŠ›æ§åˆ¶ï¼ˆINPUT+FORWARDï¼‰ï¼Œå·²æ–­å¼€è¿æ¥"
    else
        # æ™®é€šæ§åˆ¶ï¼šåªæ·»åŠ åˆ°FORWARDé“¾
        nft add rule inet znetcontrol forward ether saddr "{ $value }" drop 2>/dev/null || true
        info "ğŸ”— è§„åˆ™ã€$display_nameã€‘å·²åº”ç”¨æ™®é€šæ§åˆ¶ï¼ˆFORWARDï¼‰"
    fi
    
    info "âœ… è§„åˆ™ã€$display_nameã€‘å·²æ·»åŠ "
}

timedel() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local name=$(config_t_get device name "$id")
    [ -z "$target" ] && return
    
    # ä½¿ç”¨è§„åˆ™åç§°æˆ–ç›®æ ‡åœ°å€
    local display_name="$name"
    if [ -z "$display_name" ] || [ "$display_name" = "æ–°è§„åˆ™" ]; then
        display_name="$target"
    fi
    
    info "ç§»é™¤è®¾å¤‡æ§åˆ¶: $display_name ($target)"
    
    # è§£æç›®æ ‡ç±»å‹
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    if [ -n "$nftables_ver" ]; then
        case "$type" in
            "mac")
                nft delete element inet znetcontrol "${list_type}_list" "{ $value }" 2>/dev/null || true
                info "âœ… ä»MACé˜»æ­¢åˆ—è¡¨ç§»é™¤: $value"
                ;;
            "ipv4")
                case "$subtype" in
                    "single"|"range"|"cidr")
                        nft delete element inet znetcontrol "${list_type}_ip" "{ $value }" 2>/dev/null || true
                        info "âœ… ä»IPé˜»æ­¢åˆ—è¡¨ç§»é™¤: $value"
                        ;;
                esac
                ;;
        esac
    fi
    # æ³¨æ„ï¼šè¿™é‡Œä¸æ‰§è¡Œflush_connectionsï¼Œè®©è§„åˆ™åœ¨ä¿å­˜åæ‰ç”Ÿæ•ˆ
}

check_time() {
    local start=$1
    local end=$2
    local current=$(date +%H%M)
    local start_min=$((10#${start:0:2}*60 + 10#${start:3:2}))
    local end_min=$((10#${end:0:2}*60 + 10#${end:3:2}))
    local current_min=$((10#${current:0:2}*60 + 10#${current:2:2}))
    
    if [[ $start_min -lt $end_min ]]; then
        [[ $current_min -ge $start_min && $current_min -lt $end_min ]]
    else
        [[ $current_min -ge $start_min || $current_min -lt $end_min ]]
    fi
}

check_list() {
    local i=$1
    local start_time=$(config_t_get device timestart "$i")
    local end_time=$(config_t_get device timeend "$i")
    local wweek=$(config_t_get device week "$i")
    local current_weekday=$(date +%u)
    
    # æ£€æŸ¥æ˜ŸæœŸï¼ˆ0è¡¨ç¤ºæ¯å¤©ï¼‰
    if [ "$wweek" != "0" ]; then
        # å°†é€—å·åˆ†éš”çš„æ˜ŸæœŸè½¬æ¢ä¸ºgrepæ¨¡å¼
        local week_pattern=$(echo "$wweek" | sed 's/,/\\|/g')
        if ! echo "$current_weekday" | grep -q "^\($week_pattern\)$"; then
            dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ˜ŸæœŸå†…ï¼ˆé…ç½®: $wweek, å½“å‰: $current_weekdayï¼‰"
            return 1
        fi
    fi
    
    # å¦‚æœå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´éƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºå…¨å¤©ç”Ÿæ•ˆ
    if [ -z "$start_time" ] && [ -z "$end_time" ]; then
        dbg "è§„åˆ™ $i å…¨å¤©ç”Ÿæ•ˆ"
        return 0
    fi
    
    # è®¾ç½®é»˜è®¤å€¼
    start_time=${start_time:-"00:00"}
    end_time=${end_time:-"23:59"}
    
    # æ£€æŸ¥æ—¶é—´
    if ! check_time "$start_time" "$end_time"; then
        dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´å†…ï¼ˆ$start_time - $end_timeï¼‰"
        return 1
    fi
    
    dbg "è§„åˆ™ $i åœ¨ç”Ÿæ•ˆæ—¶é—´å†…"
    return 0
}

show_status() {
    echo ""
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚           ZNetControl ç³»ç»ŸçŠ¶æ€             â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    # æ§åˆ¶æ¨¡å¼
    if [ "$StrongCHAIN" -eq 1 ]; then
        echo "â”‚    æ§åˆ¶æ¨¡å¼: å¼ºåŠ›æ§åˆ¶ (INPUTé“¾)            â”‚"
        echo "â”‚    é˜»æ­¢è®¿é—®è·¯ç”±å™¨å’Œäº’è”ç½‘ï¼Œç«‹å³ç”Ÿæ•ˆ        â”‚"
    else
        echo "â”‚    æ§åˆ¶æ¨¡å¼: æ™®é€šæ§åˆ¶ (FORWARDé“¾)          â”‚"
        echo "â”‚    ä»…é˜»æ­¢äº’è”ç½‘è®¿é—®ï¼Œå¯èƒ½æœ‰å»¶è¿Ÿ            â”‚"
    fi
    
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
   
    # å½“å‰æ—¶é—´
    echo "â”‚ å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')              â”‚"
    echo "â”‚ æ˜ŸæœŸ: $(date '+%u' | sed 's/1/æ˜ŸæœŸä¸€/;s/2/æ˜ŸæœŸäºŒ/;s/3/æ˜ŸæœŸä¸‰/;s/4/æ˜ŸæœŸå››/;s/5/æ˜ŸæœŸäº”/;s/6/æ˜ŸæœŸå…­/;s/7/æ˜ŸæœŸæ—¥/') â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    if [ -s "$IDLIST" ]; then
    local device_count=$(wc -l < $IDLIST 2>/dev/null || echo "0")
    echo "â”‚ æ§åˆ¶è®¾å¤‡æ•°: $device_count ä¸ª                           â”‚"
    
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚ æ§åˆ¶ä¸­çš„è®¾å¤‡:                              â”‚"
        local count=0
        cat "$IDLIST" | sed 's/!//g' | head -5 | while read id; do
            count=$((count + 1))
            local target=$(config_t_get device target "$id")
            local comment=$(config_t_get device comment "$id" "è®¾å¤‡$id")
            printf "â”‚ %2d  %-15s %-20s     â”‚\n" $count "$comment" "$target"
        done
        
        if [ $device_count -gt 5 ]; then
            echo "â”‚ ... è¿˜æœ‰ $(($device_count - 5)) ä¸ªè®¾å¤‡           â”‚"
        fi
    else
        echo "â”‚ æ§åˆ¶è®¾å¤‡æ•°: 0 ä¸ª                            â”‚"
    fi
    
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
}

show_help() {
    echo "ZNetControl ä¸Šç½‘æ—¶é—´æ§åˆ¶ç³»ç»Ÿ"
    echo ""
    echo "æ”¯æŒçš„åœ°å€æ ¼å¼:"
    echo "  1. å•ä¸ªIP: 192.168.1.100"
    echo "  2. IPèŒƒå›´: 192.168.1.1-192.168.1.100"
    echo "  3. CIDR: 192.168.1.0/24"
    echo "  4. MACåœ°å€: 00:11:22:33:44:55"
    echo ""
    echo "ç”¨æ³•: $0 {start|stop|add <id>|del <id>|status|help}"
    echo ""
    echo "é…ç½®: ç¼–è¾‘ /etc/config/znetcontrol"
    echo "æ—¥å¿—: æŸ¥çœ‹ /var/log/znetcontrol.log"
}

get_enabled_rule_ids() {
    # æ–¹æ³•1ï¼šç›´æ¥è¯»å–é…ç½®æ–‡ä»¶
    uci show znetcontrol 2>/dev/null | grep -E "\.enable='1'" | grep "\.target" | cut -d'.' -f2 | cut -d'=' -f1 | sort -u
    
    # æ–¹æ³•2ï¼šå¤‡ç”¨æ–¹æ³•
    # uci get znetcontrol.@device[0].enable 2>/dev/null | grep -q '1' && echo "0"
}

# Check if nftables/iptables is available
if [ -x "$bin_nft" ]; then
    nftables_ver="true"
    dbg "nft found: $bin_nft"
elif [ -x "$bin_iptables" ] || [ -x "$bin_ip6tables" ]; then
    iptables_ver="true"
    dbg "iptables found: $bin_iptables"
else
    dbg "No firewall tool found!"
    exit 1
fi

if is_input_chain; then
    StrongCHAIN=1
else
    StrongCHAIN=0
fi

case "$crrun" in
    "stop")
        info "åœæ­¢æ—¶é—´æ§åˆ¶æœåŠ¡"
        stop_timecontrol
        info "æ‰€æœ‰é˜²ç«å¢™è§„åˆ™å·²æ¸…é™¤"
        ;;
        "start")
        stop_timecontrol
        echo -e "\n====== å¯åŠ¨ ZNetControl ======" > /var/log/znetcontrol.log
        mkdir -p /var/log /var/run 2>/dev/null
        touch "$IDLIST" 2>/dev/null
        
        info "ä»é…ç½®æ–‡ä»¶åŠ è½½è§„åˆ™..."
        
        # è·å–æ‰€æœ‰å¯ç”¨çš„è§„åˆ™IDï¼ˆä¿®å¤åçš„æ–¹æ³•ï¼‰
        local enabled_ids=""
        local rule_index=0
        
        # å¾ªç¯æ£€æŸ¥æ‰€æœ‰deviceæ®µ
        while true; do
            local enable_val=$(uci -q get znetcontrol.@device[$rule_index].enable)
            local target_val=$(uci -q get znetcontrol.@device[$rule_index].target)
            
            # å¦‚æœæ²¡æœ‰æ›´å¤šè§„åˆ™ï¼Œè·³å‡ºå¾ªç¯
            if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                break
            fi
            
            # å¦‚æœè§„åˆ™å¯ç”¨ä¸”æœ‰ç›®æ ‡åœ°å€
            if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                info "æ‰¾åˆ°å¯ç”¨è§„åˆ™ $rule_index: $target_val"
                enabled_ids="$enabled_ids $rule_index"
                echo "!${rule_index}!" >> "$IDLIST"
            fi
            
            rule_index=$((rule_index + 1))
        done
        
        info "å‘ç°å¯ç”¨è§„åˆ™: $(echo $enabled_ids | wc -w) ä¸ª"
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è§„åˆ™ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ—§çš„ruleæ®µï¼ˆå…¼å®¹æ€§ï¼‰
        if [ -z "$enabled_ids" ]; then
            info "æ£€æŸ¥æ—§æ ¼å¼è§„åˆ™..."
            local old_rule_index=0
            while true; do
                local enable_val=$(uci -q get znetcontrol.@rule[$old_rule_index].enabled)
                local target_val=$(uci -q get znetcontrol.@rule[$old_rule_index].target)
                
                if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                    break
                fi
                
                if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                    info "æ‰¾åˆ°æ—§æ ¼å¼å¯ç”¨è§„åˆ™ $old_rule_index: $target_val"
                    enabled_ids="$enabled_ids $old_rule_index"
                    echo "!${old_rule_index}!" >> "$IDLIST"
                fi
                
                old_rule_index=$((old_rule_index + 1))
            done
        fi
        
        init_timecontrol
        
        # å¤„ç†æ¯ä¸ªå¯ç”¨è§„åˆ™
        if [ -n "$enabled_ids" ]; then
            for id in $enabled_ids; do
                info "å¤„ç†è§„åˆ™ $id"
                if check_list "$id"; then
                    timeadd "$id"
                    info "âœ… è®¾å¤‡ $id å·²æ·»åŠ åˆ°æ§åˆ¶åˆ—è¡¨"
                else
                    if grep -q "!${id}!" "$IDLIST"; then
                        timedel "$id"
                        sed -i "/!$id!/d" "$IDLIST"
                        info "â° è®¾å¤‡ $id ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´ï¼Œå·²ç§»é™¤"
                    fi
                fi
            done
        else
            info "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨è§„åˆ™"
        fi
        
        info "æ—¶é—´æ§åˆ¶å¯åŠ¨å®Œæˆï¼Œæ§åˆ¶ $(wc -l < $IDLIST 2>/dev/null || echo 0) ä¸ªè®¾å¤‡"
        show_status
        ;;
    "add")
        info "æ·»åŠ è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            if check_list "$list"; then
                timeadd "$list"
                if ! grep -q "!$list!" "$IDLIST"; then
                    echo "!$list!" >> "$IDLIST"
                fi
                info "è®¾å¤‡ $list å·²æ·»åŠ "
            else
                if grep -q "!${list}!" "$IDLIST"; then
                    timedel "$list"
                    sed -i "/!$list!/d" "$IDLIST"
                    info "è®¾å¤‡ $list å·²ç§»é™¤"
                fi
            fi
        done
        ;;
    "del")
        info "ç§»é™¤è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            timedel "$list"
            sed -i "/!$list!/d" "$IDLIST"
            info "è®¾å¤‡ $list å·²åˆ é™¤"
        done
        ;;
    "status")
        show_status
        ;;
    "help"|"")
        show_help
        ;;
    *)
        dbg "æ— æ•ˆå‘½ä»¤: $crrun"
        show_help
        exit 1
        ;;
esac

