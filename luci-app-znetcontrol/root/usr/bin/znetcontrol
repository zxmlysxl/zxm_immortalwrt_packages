#!/bin/bash

crrun=$1
crid=$2
NAME=znetcontrol
DEBUG=0

RULE_SECTION="device"

NFT_TABLE="inet $NAME"
LOG_FILE="/var/log/$NAME.log"
CONFIG_FILE="/etc/config/$NAME"

# è¿™äº›å˜é‡éœ€è¦åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰
IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"
CHAIN="forward"  # è®¾ç½®é»˜è®¤å€¼ï¼Œåé¢ä¼šä»é…ç½®ä¸­è¯»å–

bin_nft=$(which nft 2>/dev/null)
bin_iptables=$(which iptables 2>/dev/null)
bin_ip6tables=$(which ip6tables 2>/dev/null)
bin_conntrack=$(which conntrack 2>/dev/null)

# è·å–è§„åˆ™åç§°çš„è¾…åŠ©å‡½æ•°
get_rule_display_name() {
    local id=$1
    local name=$(config_t_get device name "$id")
    local target=$(config_t_get device target "$id")
    
    if [ -z "$name" ] || [ "$name" = "æ–°è§„åˆ™" ]; then
        if [ -n "$target" ]; then
            name="$target"
        else
            name="è§„åˆ™$id"
        fi
    fi
    
    echo "$name"
}

config_get_type() {
    local ret=$(uci -q get "${NAME}.${1}")
    echo "${ret:=$2}"
}

config_n_get() {
    local ret=$(uci -q get "${NAME}.${1}.${2}")
    echo "${ret:=$3}"
}

config_t_get() {
    local index=${3:-0}
    local default=$4
    local ret=$(uci -q get "${NAME}.@${1}[${index}].${2}")
    echo "${ret:-$default}"
}

config_t_set() {
    local index=${4:-0}
    local ret=$(uci -q set "${NAME}.@${1}[${index}].${2}=${3}")
}

# ç§»åŠ¨åˆ°å‡½æ•°å†…éƒ¨æˆ–ä½¿ç”¨å…¨å±€å˜é‡
list_type="blacklist"  # é»˜è®¤å€¼

is_input_chain() {
    [ "$CHAIN" = "input" ]
}

log() {
    local d="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$d] $@" >>$LOG_FILE
}

info() {
    log "INFO: $@"
}

dbg() {
    [ "$DEBUG" -eq 1 ] && log "DEBUG: $@"
}

parse_target() {
    local target="$1"
    
    target=$(echo "${target}" | xargs)
    
    # å•ä¸ªIPåœ°å€
    if echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local octets=(${target//./ })
        for octet in "${octets[@]}"; do
            [ "$octet" -le 255 ] || return 1
        done
        echo "ipv4:single:${target}"
        return 0
    
    # IPèŒƒå›´
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}-([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local start_ip=${target%-*}
        local end_ip=${target#*-}
        
        local start_octets=(${start_ip//./ })
        local end_octets=(${end_ip//./ })
        for i in {0..3}; do
            [ "${start_octets[$i]}" -le 255 ] && [ "${end_octets[$i]}" -le 255 ] || return 1
        done
        
        echo "ipv4:range:${target}"
        return 0
    
    # CIDRæ ¼å¼
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$'; then
        local ip=${target%/*}
        local mask=${target#*/}
        
        if [ "$mask" -ge 0 ] && [ "$mask" -le 32 ]; then
            local octets=(${ip//./ })
            for octet in "${octets[@]}"; do
                [ "$octet" -le 255 ] || return 1
            done
            echo "ipv4:cidr:${target}"
            return 0
        fi
    
    # MACåœ°å€
    elif echo "$target" | grep -qE '^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$'; then
        echo "mac:single:${target,,}"
        return 0
    
    # IPv6åœ°å€
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$'; then
        echo "ipv6:single:${target}"
        return 0
    
    # IPv6 CIDR
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}/[0-9]{1,3}$'; then
        local ipv6=${target%/*}
        local mask=${target#*/}
        if [ "$mask" -ge 0 ] && [ "$mask" -le 128 ]; then
            echo "ipv6:cidr:${target}"
            return 0
        fi
    fi
    
    return 1
}

convert_to_old_format() {
    local target="$1"
    local parsed_result=$(parse_target "$target")
    [ $? -ne 0 ] && return 1
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    case "$type" in
        "ipv4")
            case "$subtype" in
                "single") 
                    echo "ip ipv4_addr $value"
                    ;;
                "range")
                    local start_ip=${value%-*}
                    local end_ip=${value#*-}
                    echo "ip ipv4_addr { $start_ip-$end_ip }"
                    ;;
                "cidr")
                    echo "ip ipv4_addr $value"
                    ;;
            esac
            ;;
        "mac")
            echo "bridge ether_addr $value"
            ;;
        "ipv6")
            case "$subtype" in
                "single") echo "ip6 ipv6_addr $value" ;;
                "cidr") echo "ip6 ipv6_addr $value" ;;
            esac
            ;;
    esac
}

flush_connections() {
    local target="$1"
    
    if [ -x "$bin_conntrack" ]; then
        local parsed_result=$(parse_target "${target}")
        if [ $? -eq 0 ]; then
            IFS=':' read -r type subtype value <<< "${parsed_result}"
            
            case "${type}" in
                "ipv4")
                    case "$subtype" in
                        "single")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†IPè¿æ¥: ${value}"
                            ;;
                        "cidr")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†CIDRè¿æ¥: ${value}"
                            ;;
                    esac
                    info "æ–­å¼€è¿æ¥: ${target}"
                    ;;
                "mac")
                    if [ -f "/proc/net/arp" ]; then
                        local ip_addr=$(grep -i "${value}" /proc/net/arp 2>/dev/null | awk '{print $1}' | head -1)
                        if [ -n "${ip_addr}" ]; then
                            $bin_conntrack -D -s "${ip_addr}" 2>/dev/null || true
                            $bin_conntrack -D -d "${ip_addr}" 2>/dev/null || true
                            dbg "æ¸…ç†MACè¿æ¥: ${value} (IP: ${ip_addr})"
                            info "æ–­å¼€MACè¿æ¥: ${value}"
                        fi
                    fi
                    ;;
            esac
        else
            dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: ${target}"
        fi
    else
        dbg "conntrackæœªå®‰è£…"
    fi
}

nft_table_exists() {
    local table=$1
    nft list tables | grep -q "$table"
}

nft_set_exists() {
    local table=$1
    local set=$2
    nft list sets | grep -q "$table $set"
}

stop_timecontrol() {
    if [ -n "$nftables_ver" ]; then
        nft delete table $NFT_TABLE 2>/dev/null && info "å·²æ¸…ç†nftablesè§„åˆ™"
    fi

    rm -rf  "$IDLIST" "$TMPID" 2>/dev/null
}

init_timecontrol() {
    info "åˆå§‹åŒ–æ—¶é—´æ§åˆ¶"
    
    if [ -n "$nftables_ver" ]; then
        # æ¸…ç†æ‰€æœ‰ç›¸å…³è¡¨
        nft delete table ip znetcontrol 2>/dev/null || true
        nft delete table ip6 znetcontrol 2>/dev/null || true
        nft delete table bridge znetcontrol 2>/dev/null || true
        
        # ========== IPv4è¡¨ ==========
        nft add table ip znetcontrol
        nft add set ip znetcontrol blacklist_ip_input "{ type ipv4_addr; flags interval; }" 2>/dev/null || true
        nft add set ip znetcontrol blacklist_ip_forward "{ type ipv4_addr; flags interval; }" 2>/dev/null || true
        
        # INPUTé“¾ï¼ˆå¼ºåŠ›æ§åˆ¶ï¼‰
        nft add chain ip znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        nft add rule ip znetcontrol input ip saddr @blacklist_ip_input drop comment "block-ipv4-input"
        
        # FORWARDé“¾ï¼ˆæ™®é€šæ§åˆ¶ï¼‰
        nft add chain ip znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        nft add rule ip znetcontrol forward ip saddr @blacklist_ip_forward drop comment "block-ipv4-forward"
        
        # ========== IPv6è¡¨ ==========
        nft add table ip6 znetcontrol
        nft add set ip6 znetcontrol blacklist_ip6_input "{ type ipv6_addr; flags interval; }" 2>/dev/null || true
        nft add set ip6 znetcontrol blacklist_ip6_forward "{ type ipv6_addr; flags interval; }" 2>/dev/null || true
        
        nft add chain ip6 znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        nft add rule ip6 znetcontrol input ip6 saddr @blacklist_ip6_input drop comment "block-ipv6-input"
        
        nft add chain ip6 znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        nft add rule ip6 znetcontrol forward ip6 saddr @blacklist_ip6_forward drop comment "block-ipv6-forward"
        
        # ========== Bridgeè¡¨ï¼ˆMACåœ°å€ï¼‰ ==========
        nft add table bridge znetcontrol
        nft add set bridge znetcontrol blacklist_mac_input "{ type ether_addr; flags interval; }" 2>/dev/null || true
        nft add set bridge znetcontrol blacklist_mac_forward "{ type ether_addr; flags interval; }" 2>/dev/null || true
        
        # Bridge INPUTé“¾
        nft add chain bridge znetcontrol input "{ type filter hook input priority -300; policy accept; }"
        nft add rule bridge znetcontrol input ether saddr @blacklist_mac_input drop comment "block-mac-input"
        
        # Bridge FORWARDé“¾
        nft add chain bridge znetcontrol forward "{ type filter hook forward priority -300; policy accept; }"
        nft add rule bridge znetcontrol forward ether saddr @blacklist_mac_forward drop comment "block-mac-forward"
        
        info "nftablesè§„åˆ™åˆå§‹åŒ–å®Œæˆï¼ˆç‹¬ç«‹è¡¨æ¶æ„ï¼‰"
    fi
    
    info "åˆå§‹åŒ–å®Œæˆ"
}

timeadd() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local name=$(config_t_get device name "$id")
    local chain=$(config_t_get device chain "$id" "forward")
    [ -z "$target" ] && return
    
    # è·å–æ˜¾ç¤ºåç§°
    local display_name=$(get_rule_display_name "$id")
    
    # å°†chainè½¬æ¢ä¸ºä¸­æ–‡æ˜¾ç¤º
    local chain_display=""
    if [ "$chain" = "input" ]; then
        chain_display="å¼ºåŠ›æ§åˆ¶"
    else
        chain_display="æ™®é€šæ§åˆ¶"
    fi
    
    # ä¿®å¤æ—¥å¿—æ˜¾ç¤ºï¼šä½¿ç”¨ã€è§„åˆ™åç§°ã€‘æ ¼å¼
    info "æ·»åŠ è®¾å¤‡æ§åˆ¶: ã€$display_nameã€‘($target)ï¼Œæ§åˆ¶å¼ºåº¦: $chain_display"
    
    # è§£æç›®æ ‡ç±»å‹
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    if [ -n "$nftables_ver" ]; then
        case "$type" in
            "mac")
                # è·å–IPåœ°å€
                local device_ip=$(get_device_ip "$value")
                
                if [ "$chain" = "input" ]; then
                    # å¼ºåŠ›æ§åˆ¶
                    nft add element bridge znetcontrol blacklist_mac_input "{ $value }" 2>/dev/null
                    info "âœ… ã€$display_nameã€‘å¼ºåŠ›æ§åˆ¶ï¼šMAC $value å·²æ·»åŠ åˆ°bridge inputé›†åˆ"
                    
                    if [ -n "$device_ip" ]; then
                        nft add element ip znetcontrol blacklist_ip_input "{ $device_ip }" 2>/dev/null
                        info "ğŸ”’ ã€$display_nameã€‘å¼ºåŠ›æ§åˆ¶ï¼šåŒæ—¶æ·»åŠ IP $device_ip åˆ°inputé›†åˆ"
                    else
                        info "âš ï¸ ã€$display_nameã€‘å¼ºåŠ›æ§åˆ¶ï¼šMAC $value å·²æ·»åŠ ï¼Œä½†æœªæ‰¾åˆ°å¯¹åº”IPåœ°å€"
                        info "ğŸ’¡ ã€$display_nameã€‘æç¤ºï¼šå¦‚éœ€å®Œå…¨é˜»æ­¢è®¿é—®è·¯ç”±å™¨ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ è®¾å¤‡IPåœ°å€"
                    fi
                else
                    # æ™®é€šæ§åˆ¶
                    nft add element bridge znetcontrol blacklist_mac_forward "{ $value }" 2>/dev/null
                    
                    if [ -n "$device_ip" ]; then
                        nft add element ip znetcontrol blacklist_ip_forward "{ $device_ip }" 2>/dev/null
                        info "âœ… ã€$display_nameã€‘æ™®é€šæ§åˆ¶ï¼šMAC $value (IP: $device_ip) å·²æ·»åŠ åˆ°bridgeå’Œipè¡¨"
                    else
                        info "âš ï¸ ã€$display_nameã€‘æ™®é€šæ§åˆ¶ï¼šMAC $value å·²æ·»åŠ åˆ°bridgeè¡¨ï¼ˆæœªæ‰¾åˆ°IPï¼Œå¯èƒ½æ— æ³•å®Œå…¨é˜»æ­¢ä¸Šç½‘ï¼‰"
                        info "ğŸ’¡ ã€$display_nameã€‘æç¤ºï¼šå¦‚æœè®¾å¤‡ä»èƒ½ä¸Šç½‘ï¼Œè¯·å°†è®¾å¤‡IPåœ°å€æ‰‹åŠ¨æ·»åŠ åˆ°è¿‡æ»¤è§„åˆ™"
                        info "ğŸ’¡ ã€$display_nameã€‘æ‰‹åŠ¨å‘½ä»¤ï¼šnft add element ip znetcontrol blacklist_ip_forward '{ è®¾å¤‡IP }'"
                    fi
                fi
                ;;
            "ipv4")
                # IPv4åœ°å€å¤„ç†ï¼ˆä¿æŒä¸å˜ï¼‰
                case "$subtype" in
                    "single"|"range"|"cidr")
                        if [ "$chain" = "input" ]; then
                            nft add element ip znetcontrol blacklist_ip_input "{ $value }" 2>/dev/null
                        else
                            nft add element ip znetcontrol blacklist_ip_forward "{ $value }" 2>/dev/null
                        fi
                        info "âœ… ã€$display_nameã€‘IPåœ°å€: $value (æ§åˆ¶å¼ºåº¦: $chain)"
                        ;;
                esac
                ;;
        esac
    fi
}

# è·å–è®¾å¤‡IPåœ°å€
get_device_ip() {
    local mac="$1"
    local ip=""
    
    # æ ‡å‡†åŒ–MACåœ°å€æ ¼å¼ï¼ˆç»Ÿä¸€ä¸ºå°å†™å†’å·åˆ†éš”ï¼‰
    mac=$(echo "$mac" | tr '[:upper:]' '[:lower:]' | sed -e 's/-/:/g' -e 's/ //g')
    
    # æ–¹æ³•1ï¼šä»ARPè¡¨è·å–ï¼ˆæœ€å‡†ç¡®ï¼Œå®æ—¶ï¼‰
    ip=$(arp -n 2>/dev/null | awk -v search_mac="$mac" '
        BEGIN {IGNORECASE=1}
        $3 == search_mac {print $1; exit}
    ')
    
    # æ–¹æ³•2ï¼šä»/proc/net/arpè·å–ï¼ˆå¤‡ç”¨ï¼‰
    if [ -z "$ip" ]; then
        ip=$(cat /proc/net/arp 2>/dev/null | awk -v search_mac="$mac" '
            BEGIN {IGNORECASE=1}
            $4 == search_mac {print $1; exit}
        ')
    fi
    
    # æ–¹æ³•3ï¼šä»DHCPç§Ÿçº¦è·å–ï¼ˆè®¾å¤‡å¯èƒ½ç¦»çº¿ï¼‰
    if [ -z "$ip" ]; then
        # å°†MACè½¬æ¢ä¸ºDHCPæ ¼å¼ï¼ˆxx-xx-xx-xx-xx-xxï¼‰
        local mac_dash=$(echo "$mac" | tr ':' '-')
        ip=$(cat /tmp/dhcp.leases 2>/dev/null 2>/dev/null | awk -v search_mac="$mac_dash" '
            BEGIN {IGNORECASE=1}
            $2 == search_mac {print $3; exit}
        ')
    fi
    
    # æ–¹æ³•4ï¼šä»conntrackè¿æ¥ä¸­æå–ï¼ˆæœ€åæ‰‹æ®µï¼‰
    if [ -z "$ip" ]; then
        # ä»è¿æ¥è·Ÿè¸ªä¸­æŸ¥æ‰¾æœ€è¿‘ä½¿ç”¨è¯¥MACçš„è¿æ¥
        ip=$(conntrack -L 2>/dev/null | grep -i "$(echo $mac | tr ':' ' ')" | head -1 | awk '{print $5}' | cut -d= -f2)
    fi
    
    # è¿”å›ç»“æœ
    if [ -n "$ip" ]; then
        echo "$ip"
        return 0
    else
        return 1
    fi
}

timedel() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local name=$(config_t_get device name "$id")
    local chain=$(config_t_get device chain "$id" "forward")
    [ -z "$target" ] && return
    
    # è·å–æ˜¾ç¤ºåç§°
    local display_name=$(get_rule_display_name "$id")
    
    # è§£æç›®æ ‡ç±»å‹
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    if [ -n "$nftables_ver" ]; then
        case "$type" in
            "mac")
                if [ "$chain" = "input" ]; then
                    nft delete element bridge znetcontrol blacklist_mac_input "{ $value }" 2>/dev/null || true
                    info "âœ… ã€$display_nameã€‘ä»bridge input MACåˆ—è¡¨ç§»é™¤: $value"
                else
                    nft delete element bridge znetcontrol blacklist_mac_forward "{ $value }" 2>/dev/null || true
                    info "âœ… ã€$display_nameã€‘ä»bridge forward MACåˆ—è¡¨ç§»é™¤: $value"
                fi
                ;;
            "ipv4")
                case "$subtype" in
                    "single"|"range"|"cidr")
                        if [ "$chain" = "input" ]; then
                            nft delete element ip znetcontrol blacklist_ip_input "{ $value }" 2>/dev/null || true
                            info "âœ… ã€$display_nameã€‘ä»ip inputåˆ—è¡¨ç§»é™¤: $value"
                        else
                            nft delete element ip znetcontrol blacklist_ip_forward "{ $value }" 2>/dev/null || true
                            info "âœ… ã€$display_nameã€‘ä»ip forwardåˆ—è¡¨ç§»é™¤: $value"
                        fi
                        ;;
                esac
                ;;
            "ipv6")
                case "$subtype" in
                    "single"|"cidr")
                        if [ "$chain" = "input" ]; then
                            nft delete element ip6 znetcontrol blacklist_ip6_input "{ $value }" 2>/dev/null || true
                            info "âœ… ã€$display_nameã€‘ä»ip6 inputåˆ—è¡¨ç§»é™¤: $value"
                        else
                            nft delete element ip6 znetcontrol blacklist_ip6_forward "{ $value }" 2>/dev/null || true
                            info "âœ… ã€$display_nameã€‘ä»ip6 forwardåˆ—è¡¨ç§»é™¤: $value"
                        fi
                        ;;
                esac
                ;;
        esac
    fi
}

check_time() {
    local start=$1
    local end=$2
    local current=$(date +%H%M)
    local start_min=$((10#${start:0:2}*60 + 10#${start:3:2}))
    local end_min=$((10#${end:0:2}*60 + 10#${end:3:2}))
    local current_min=$((10#${current:0:2}*60 + 10#${current:2:2}))
    
    if [[ $start_min -lt $end_min ]]; then
        [[ $current_min -ge $start_min && $current_min -lt $end_min ]]
    else
        [[ $current_min -ge $start_min || $current_min -lt $end_min ]]
    fi
}

check_list() {
    local i=$1
    local start_time=$(config_t_get device timestart "$i")
    local end_time=$(config_t_get device timeend "$i")
    local wweek=$(config_t_get device week "$i")
    local current_weekday=$(date +%u)
    
    # æ£€æŸ¥æ˜ŸæœŸï¼ˆ0è¡¨ç¤ºæ¯å¤©ï¼‰
    if [ "$wweek" != "0" ]; then
        # å°†é€—å·åˆ†éš”çš„æ˜ŸæœŸè½¬æ¢ä¸ºgrepæ¨¡å¼
        local week_pattern=$(echo "$wweek" | sed 's/,/\\|/g')
        if ! echo "$current_weekday" | grep -q "^\($week_pattern\)$"; then
            dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ˜ŸæœŸå†…ï¼ˆé…ç½®: $wweek, å½“å‰: $current_weekdayï¼‰"
            return 1
        fi
    fi
    
    # å¦‚æœå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´éƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºå…¨å¤©ç”Ÿæ•ˆ
    if [ -z "$start_time" ] && [ -z "$end_time" ]; then
        dbg "è§„åˆ™ $i å…¨å¤©ç”Ÿæ•ˆ"
        return 0
    fi
    
    # è®¾ç½®é»˜è®¤å€¼
    start_time=${start_time:-"00:00"}
    end_time=${end_time:-"23:59"}
    
    # æ£€æŸ¥æ—¶é—´
    if ! check_time "$start_time" "$end_time"; then
        dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´å†…ï¼ˆ$start_time - $end_timeï¼‰"
        return 1
    fi
    
    dbg "è§„åˆ™ $i åœ¨ç”Ÿæ•ˆæ—¶é—´å†…"
    return 0
}

show_status() {
    echo ""
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚           ZNetControl ç³»ç»ŸçŠ¶æ€             â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    # æ§åˆ¶æ¨¡å¼
    if [ "$StrongCHAIN" -eq 1 ]; then
        echo "â”‚    æ§åˆ¶æ¨¡å¼: å¼ºåŠ›æ§åˆ¶ (INPUTé“¾)            â”‚"
        echo "â”‚    é˜»æ­¢è®¿é—®è·¯ç”±å™¨å’Œäº’è”ç½‘ï¼Œç«‹å³ç”Ÿæ•ˆ        â”‚"
    else
        echo "â”‚    æ§åˆ¶æ¨¡å¼: æ™®é€šæ§åˆ¶ (FORWARDé“¾)          â”‚"
        echo "â”‚    ä»…é˜»æ­¢äº’è”ç½‘è®¿é—®ï¼Œå¯èƒ½æœ‰å»¶è¿Ÿ            â”‚"
    fi
    
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
   
    # å½“å‰æ—¶é—´
    echo "â”‚ å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')              â”‚"
    echo "â”‚ æ˜ŸæœŸ: $(date '+%u' | sed 's/1/æ˜ŸæœŸä¸€/;s/2/æ˜ŸæœŸäºŒ/;s/3/æ˜ŸæœŸä¸‰/;s/4/æ˜ŸæœŸå››/;s/5/æ˜ŸæœŸäº”/;s/6/æ˜ŸæœŸå…­/;s/7/æ˜ŸæœŸæ—¥/') â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    if [ -s "$IDLIST" ]; then
        local device_count=$(wc -l < $IDLIST 2>/dev/null || echo "0")
        echo "â”‚ æ§åˆ¶è®¾å¤‡æ•°: $device_count ä¸ª                           â”‚"
        
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚ æ§åˆ¶ä¸­çš„è®¾å¤‡:                              â”‚"
        local count=0
        cat "$IDLIST" | sed 's/!//g' | head -5 | while read id; do
            count=$((count + 1))
            local target=$(config_t_get device target "$id")
            local display_name=$(get_rule_display_name "$id")
            printf "â”‚ %2d  %-15s %-20s     â”‚\n" $count "$display_name" "$target"
        done
        
        if [ $device_count -gt 5 ]; then
            echo "â”‚ ... è¿˜æœ‰ $(($device_count - 5)) ä¸ªè®¾å¤‡           â”‚"
        fi
    else
        echo "â”‚ æ§åˆ¶è®¾å¤‡æ•°: 0 ä¸ª                            â”‚"
    fi
    
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
}

show_help() {
    echo "ZNetControl ä¸Šç½‘æ—¶é—´æ§åˆ¶ç³»ç»Ÿ"
    echo ""
    echo "æ”¯æŒçš„åœ°å€æ ¼å¼:"
    echo "  1. å•ä¸ªIP: 192.168.1.100"
    echo "  2. IPèŒƒå›´: 192.168.1.1-192.168.1.100"
    echo "  3. CIDR: 192.168.1.0/24"
    echo "  4. MACåœ°å€: 00:11:22:33:44:55"
    echo ""
    echo "ç”¨æ³•: $0 {start|stop|add <id>|del <id>|status|help}"
    echo ""
    echo "é…ç½®: ç¼–è¾‘ /etc/config/znetcontrol"
    echo "æ—¥å¿—: æŸ¥çœ‹ /var/log/znetcontrol.log"
}

get_enabled_rule_ids() {
    local rule_ids=""
    local index=0
    
    # æ£€æŸ¥æ–°çš„deviceæ®µ
    while true; do
        local enable_val=$(uci -q get znetcontrol.@device[$index].enable)
        local target_val=$(uci -q get znetcontrol.@device[$index].target)
        
        if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
            break
        fi
        
        if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
            rule_ids="$rule_ids $index"
        fi
        
        index=$((index + 1))
    done
    
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€æŸ¥æ—§çš„ruleæ®µ
    if [ -z "$rule_ids" ]; then
        index=0
        while true; do
            local enable_val=$(uci -q get znetcontrol.@rule[$index].enabled)
            local target_val=$(uci -q get znetcontrol.@rule[$index].target)
            
            if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                break
            fi
            
            if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                rule_ids="$rule_ids $index"
            fi
            
            index=$((index + 1))
        done
    fi
    
    echo $rule_ids
}

# Check if nftables/iptables is available
if [ -x "$bin_nft" ]; then
    nftables_ver="true"
    dbg "nft found: $bin_nft"
elif [ -x "$bin_iptables" ] || [ -x "$bin_ip6tables" ]; then
    iptables_ver="true"
    dbg "iptables found: $bin_iptables"
else
    dbg "No firewall tool found!"
    exit 1
fi

# ä»é…ç½®è¯»å–chainå’Œlist_type
CHAIN=$(uci -q get znetcontrol.settings.chain || echo "forward")
list_type=$(uci -q get znetcontrol.settings.control_mode || echo "blacklist")

if is_input_chain; then
    StrongCHAIN=1
else
    StrongCHAIN=0
fi

case "$crrun" in
    "start")
        stop_timecontrol
        # ä¿®å¤ï¼šä½¿ç”¨è¿½åŠ æ¨¡å¼è€Œä¸æ˜¯è¦†ç›–
        echo -e "\n====== å¯åŠ¨ ZNetControl ======" >> /var/log/znetcontrol.log
        mkdir -p /var/log /var/run 2>/dev/null
        touch "$IDLIST" 2>/dev/null
        
        info "ä»é…ç½®æ–‡ä»¶åŠ è½½è§„åˆ™..."
        
        # è·å–æ‰€æœ‰å¯ç”¨çš„è§„åˆ™ID
        enabled_ids=$(get_enabled_rule_ids)
        info "å‘ç°å¯ç”¨è§„åˆ™: $(echo $enabled_ids | wc -w) ä¸ª"
        
        if [ -z "$enabled_ids" ]; then
            info "æ£€æŸ¥æ—§æ ¼å¼è§„åˆ™..."
            RULE_SECTION="rule"
            enabled_ids=$(get_enabled_rule_ids)
            RULE_SECTION="device"
        fi
        
        init_timecontrol
        
        # å¤„ç†æ¯ä¸ªå¯ç”¨è§„åˆ™
        if [ -n "$enabled_ids" ]; then
            for id in $enabled_ids; do
                # è·å–è§„åˆ™åç§°
                display_name=$(get_rule_display_name "$id")
                
                info "å¤„ç†ã€$display_nameã€‘"
                if check_list "$id"; then
                    timeadd "$id"
                    echo "!${id}!" >> "$IDLIST"
                    info "âœ… ã€$display_nameã€‘å·²æ·»åŠ åˆ°æ§åˆ¶åˆ—è¡¨"
                else
                    info "â° ã€$display_nameã€‘ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´"
                fi
            done
        else
            info "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨è§„åˆ™"
        fi
        
        info "æ—¶é—´æ§åˆ¶å¯åŠ¨å®Œæˆï¼Œæ§åˆ¶ $(wc -l < $IDLIST 2>/dev/null || echo 0) ä¸ªè®¾å¤‡"
        show_status
        ;;
        
    "stop")
        info "åœæ­¢æ—¶é—´æ§åˆ¶æœåŠ¡"
        stop_timecontrol
        info "æ‰€æœ‰é˜²ç«å¢™è§„åˆ™å·²æ¸…é™¤"
        ;;
        
    "add")
        info "æ·»åŠ è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            # è·å–è§„åˆ™åç§°
            local display_name=$(get_rule_display_name "$list")
            
            if check_list "$list"; then
                timeadd "$list"
                if ! grep -q "!$list!" "$IDLIST"; then
                    echo "!$list!" >> "$IDLIST"
                fi
                info "ã€$display_nameã€‘å·²æ·»åŠ "
            else
                if grep -q "!${list}!" "$IDLIST"; then
                    timedel "$list"
                    sed -i "/!$list!/d" "$IDLIST"
                    info "ã€$display_nameã€‘å·²ç§»é™¤"
                fi
            fi
        done
        ;;
        
    "del")
        info "ç§»é™¤è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            # è·å–è§„åˆ™åç§°
            local display_name=$(get_rule_display_name "$list")
            
            timedel "$list"
            sed -i "/!$list!/d" "$IDLIST"
            info "ã€$display_nameã€‘å·²åˆ é™¤"
        done
        ;;
        
    "status")
        show_status
        ;;
        
    "help"|"")
        show_help
        ;;
        
    *)
        dbg "æ— æ•ˆå‘½ä»¤: $crrun"
        show_help
        exit 1
        ;;
esac
