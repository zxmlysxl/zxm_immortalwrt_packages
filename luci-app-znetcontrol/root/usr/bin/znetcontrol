#!/bin/bash

crrun=$1
crid=$2
NAME=znetcontrol
DEBUG=0

RULE_SECTION="device"
LOG_FILE="/var/log/$NAME.log"
CONFIG_FILE="/etc/config/$NAME"
IDLIST="/var/run/$NAME.idlist"
TMPID="/var/run/$NAME.tmpid"

# ç½‘å…³æ¨¡å¼å˜é‡
GATEWAY_MODE=""
BYPASS_GATEWAY=""
BYPASS_GATEWAY_MAC=""

# å·¥å…·æ£€æŸ¥
bin_nft=$(which nft 2>/dev/null)
bin_iptables=$(which iptables 2>/dev/null)
bin_ip6tables=$(which ip6tables 2>/dev/null)
bin_conntrack=$(which conntrack 2>/dev/null)

# è·å–è§„åˆ™åç§°çš„è¾…åŠ©å‡½æ•°
get_rule_display_name() {
    local id=$1
    local name=$(config_t_get device name "$id")
    local target=$(config_t_get device target "$id")
    
    if [ -z "$name" ] || [ "$name" = "æ–°è§„åˆ™" ]; then
        if [ -n "$target" ]; then
            name="$target"
        else
            name="è§„åˆ™$id"
        fi
    fi
    
    echo "$name"
}

config_get_type() {
    local ret=$(uci -q get "${NAME}.${1}")
    echo "${ret:=$2}"
}

config_n_get() {
    local ret=$(uci -q get "${NAME}.${1}.${2}")
    echo "${ret:=$3}"
}

config_t_get() {
    local index=${3:-0}
    local default=$4
    local ret=$(uci -q get "${NAME}.@${1}[${index}].${2}")
    echo "${ret:-$default}"
}

config_t_set() {
    local index=${4:-0}
    local ret=$(uci -q set "${NAME}.@${1}[${index}].${2}=${3}")
}

list_type="blacklist"

is_input_chain() {
    [ "$CHAIN" = "input" ]
}

log() {
    local d="$(date '+%Y-%m-%d %H:%M:%S')"
    echo "[$d] $@" >>$LOG_FILE
}

info() {
    log "INFO: $@"
}

dbg() {
    [ "$DEBUG" -eq 1 ] && log "DEBUG: $@"
}

parse_target() {
    local target="$1"
    
    target=$(echo "${target}" | xargs)
    
    # å•ä¸ªIPåœ°å€
    if echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local octets=(${target//./ })
        for octet in "${octets[@]}"; do
            [ "$octet" -le 255 ] || return 1
        done
        echo "ipv4:single:${target}"
        return 0
    
    # IPèŒƒå›´
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}-([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
        local start_ip=${target%-*}
        local end_ip=${target#*-}
        
        local start_octets=(${start_ip//./ })
        local end_octets=(${end_ip//./ })
        for i in {0..3}; do
            [ "${start_octets[$i]}" -le 255 ] && [ "${end_octets[$i]}" -le 255 ] || return 1
        done
        
        echo "ipv4:range:${target}"
        return 0
    
    # CIDRæ ¼å¼
    elif echo "$target" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$'; then
        local ip=${target%/*}
        local mask=${target#*/}
        
        if [ "$mask" -ge 0 ] && [ "$mask" -le 32 ]; then
            local octets=(${ip//./ })
            for octet in "${octets[@]}"; do
                [ "$octet" -le 255 ] || return 1
            done
            echo "ipv4:cidr:${target}"
            return 0
        fi
    
    # MACåœ°å€
    elif echo "$target" | grep -qE '^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$'; then
        echo "mac:single:${target,,}"
        return 0
    
    # IPv6åœ°å€
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$'; then
        echo "ipv6:single:${target}"
        return 0
    
    # IPv6 CIDR
    elif echo "$target" | grep -qE '^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}/[0-9]{1,3}$'; then
        local ipv6=${target%/*}
        local mask=${target#*/}
        if [ "$mask" -ge 0 ] && [ "$mask" -le 128 ]; then
            echo "ipv6:cidr:${target}"
            return 0
        fi
    fi
    
    return 1
}

convert_to_old_format() {
    local target="$1"
    local parsed_result=$(parse_target "$target")
    [ $? -ne 0 ] && return 1
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    case "$type" in
        "ipv4")
            case "$subtype" in
                "single") 
                    echo "ip ipv4_addr $value"
                    ;;
                "range")
                    local start_ip=${value%-*}
                    local end_ip=${value#*-}
                    echo "ip ipv4_addr { $start_ip-$end_ip }"
                    ;;
                "cidr")
                    echo "ip ipv4_addr $value"
                    ;;
            esac
            ;;
        "mac")
            echo "bridge ether_addr $value"
            ;;
        "ipv6")
            case "$subtype" in
                "single") echo "ip6 ipv6_addr $value" ;;
                "cidr") echo "ip6 ipv6_addr $value" ;;
            esac
            ;;
    esac
}

flush_connections() {
    local target="$1"
    
    if [ -x "$bin_conntrack" ]; then
        local parsed_result=$(parse_target "${target}")
        if [ $? -eq 0 ]; then
            IFS=':' read -r type subtype value <<< "${parsed_result}"
            
            case "${type}" in
                "ipv4")
                    case "$subtype" in
                        "single")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†IPè¿æ¥: ${value}"
                            ;;
                        "cidr")
                            $bin_conntrack -D -s "${value}" 2>/dev/null || true
                            $bin_conntrack -D -d "${value}" 2>/dev/null || true
                            dbg "æ¸…ç†CIDRè¿æ¥: ${value}"
                            ;;
                    esac
                    info "æ–­å¼€è¿æ¥: ${target}"
                    ;;
                "mac")
                    if [ -f "/proc/net/arp" ]; then
                        local ip_addr=$(grep -i "${value}" /proc/net/arp 2>/dev/null | awk '{print $1}' | head -1)
                        if [ -n "${ip_addr}" ]; then
                            $bin_conntrack -D -s "${ip_addr}" 2>/dev/null || true
                            $bin_conntrack -D -d "${ip_addr}" 2>/dev/null || true
                            dbg "æ¸…ç†MACè¿æ¥: ${value} (IP: ${ip_addr})"
                            info "æ–­å¼€MACè¿æ¥: ${value}"
                        fi
                    fi
                    ;;
            esac
        else
            dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: ${target}"
        fi
    else
        dbg "conntrackæœªå®‰è£…"
    fi
}

get_enabled_rule_ids() {
    local rule_ids=""
    local index=0
    
    while true; do
        local enable_val=$(uci -q get znetcontrol.@device[$index].enable)
        local target_val=$(uci -q get znetcontrol.@device[$index].target)
        
        if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
            break
        fi
        
        if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
            rule_ids="$rule_ids $index"
        fi
        
        index=$((index + 1))
    done
    
    if [ -z "$rule_ids" ]; then
        index=0
        while true; do
            local enable_val=$(uci -q get znetcontrol.@rule[$index].enabled)
            local target_val=$(uci -q get znetcontrol.@rule[$index].target)
            
            if [ -z "$enable_val" ] && [ -z "$target_val" ]; then
                break
            fi
            
            if [ "$enable_val" = "1" ] && [ -n "$target_val" ]; then
                rule_ids="$rule_ids $index"
            fi
            
            index=$((index + 1))
        done
    fi
    
    echo $rule_ids
}

get_device_ip() {
    local mac="$1"
    local ip=""
    
    mac=$(echo "$mac" | tr '[:upper:]' '[:lower:]' | sed -e 's/-/:/g' -e 's/ //g')
    
    if [ -f "/proc/net/arp" ]; then
        ip=$(cat /proc/net/arp 2>/dev/null | awk -v search_mac="$mac" '
            BEGIN {IGNORECASE=1}
            $4 == search_mac {print $1; exit}
        ')
    fi
    
    if [ -z "$ip" ]; then
        local mac_dash=$(echo "$mac" | tr ':' '-')
        ip=$(cat /tmp/dhcp.leases 2>/dev/null | awk -v search_mac="$mac_dash" '
            BEGIN {IGNORECASE=1}
            $2 == search_mac {print $3; exit}
        ')
    fi
    
    if [ -z "$ip" ]; then
        ip=$(conntrack -L 2>/dev/null | grep -i "$(echo $mac | tr ':' ' ')" | head -1 | awk '{print $5}' | cut -d= -f2)
    fi
    
    if [ -n "$ip" ]; then
        echo "$ip"
        return 0
    else
        return 1
    fi
}

check_time() {
    local start=$1
    local end=$2
    local current=$(date +%H%M)
    local start_min=$((10#${start:0:2}*60 + 10#${start:3:2}))
    local end_min=$((10#${end:0:2}*60 + 10#${end:3:2}))
    local current_min=$((10#${current:0:2}*60 + 10#${current:2:2}))
    
    if [[ $start_min -lt $end_min ]]; then
        [[ $current_min -ge $start_min && $current_min -lt $end_min ]]
    else
        [[ $current_min -ge $start_min || $current_min -lt $end_min ]]
    fi
}

check_list() {
    local i=$1
    local start_time=$(config_t_get device timestart "$i")
    local end_time=$(config_t_get device timeend "$i")
    local wweek=$(config_t_get device week "$i")
    local current_weekday=$(date +%u)
    
    if [ "$wweek" != "0" ]; then
        local week_pattern=$(echo "$wweek" | sed 's/,/\\|/g')
        if ! echo "$current_weekday" | grep -q "^\($week_pattern\)$"; then
            dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ˜ŸæœŸå†…ï¼ˆé…ç½®: $wweek, å½“å‰: $current_weekdayï¼‰"
            return 1
        fi
    fi
    
    if [ -z "$start_time" ] && [ -z "$end_time" ]; then
        dbg "è§„åˆ™ $i å…¨å¤©ç”Ÿæ•ˆ"
        return 0
    fi
    
    start_time=${start_time:-"00:00"}
    end_time=${end_time:-"23:59"}
    
    if ! check_time "$start_time" "$end_time"; then
        dbg "è§„åˆ™ $i ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´å†…ï¼ˆ$start_time - $end_timeï¼‰"
        return 1
    fi
    
    dbg "è§„åˆ™ $i åœ¨ç”Ÿæ•ˆæ—¶é—´å†…"
    return 0
}

detect_gateway_mode() {
    local default_gw=$(ip route show default 2>/dev/null | head -1 | awk '{print $3}')
    local lan_iface=$(uci get network.lan.ifname 2>/dev/null || echo "br-lan")
    local my_lan_ip=$(ip -4 addr show dev "$lan_iface" 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 | head -1)
    
    if [ -z "$default_gw" ] || [ "$default_gw" = "$my_lan_ip" ] || [ "$default_gw" = "0.0.0.0" ]; then
        GATEWAY_MODE="main"
        info "æ£€æµ‹ä¸ºä¸»è·¯ç”±æ¨¡å¼"
    else
        GATEWAY_MODE="bypass"
        BYPASS_GATEWAY="$default_gw"
        BYPASS_GATEWAY_MAC=$(arp -n "$default_gw" 2>/dev/null | awk '{print $3}' | grep -v "HWaddress")
        info "æ£€æµ‹ä¸ºæ—è·¯ç”±æ¨¡å¼ï¼Œç½‘å…³: $default_gw"
    fi
}

init_main_route() {
    info "åˆå§‹åŒ–ä¸»è·¯ç”±æ¨¡å¼"
    
    if [ -n "$bin_nft" ]; then
        nft delete table ip znetcontrol 2>/dev/null || true
        nft delete table ip6 znetcontrol 2>/dev/null || true
        nft delete table bridge znetcontrol 2>/dev/null || true
        
        # IPv4è¡¨
        nft add table ip znetcontrol
        nft add set ip znetcontrol blacklist_ip_input "{ type ipv4_addr; flags interval; }" 2>/dev/null || true
        nft add set ip znetcontrol blacklist_ip_forward "{ type ipv4_addr; flags interval; }" 2>/dev/null || true
        
        nft add chain ip znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        nft add rule ip znetcontrol input ip saddr @blacklist_ip_input drop comment "block-ipv4-input"
        
        nft add chain ip znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        nft add rule ip znetcontrol forward ip saddr @blacklist_ip_forward drop comment "block-ipv4-forward"
        
        # IPv6è¡¨
        nft add table ip6 znetcontrol
        nft add set ip6 znetcontrol blacklist_ip6_input "{ type ipv6_addr; flags interval; }" 2>/dev/null || true
        nft add set ip6 znetcontrol blacklist_ip6_forward "{ type ipv6_addr; flags interval; }" 2>/dev/null || true
        
        nft add chain ip6 znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        nft add rule ip6 znetcontrol input ip6 saddr @blacklist_ip6_input drop comment "block-ipv6-input"
        
        nft add chain ip6 znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        nft add rule ip6 znetcontrol forward ip6 saddr @blacklist_ip6_forward drop comment "block-ipv6-forward"
        
        # Bridgeè¡¨ï¼ˆMACåœ°å€ï¼‰
        nft add table bridge znetcontrol
        nft add set bridge znetcontrol blacklist_mac_input "{ type ether_addr; flags interval; }" 2>/dev/null || true
        nft add set bridge znetcontrol blacklist_mac_forward "{ type ether_addr; flags interval; }" 2>/dev/null || true
        
        nft add chain bridge znetcontrol input "{ type filter hook input priority -300; policy accept; }"
        nft add rule bridge znetcontrol input ether saddr @blacklist_mac_input drop comment "block-mac-input"
        
        nft add chain bridge znetcontrol forward "{ type filter hook forward priority -300; policy accept; }"
        nft add rule bridge znetcontrol forward ether saddr @blacklist_mac_forward drop comment "block-mac-forward"
    fi
}

init_bypass_route() {
    info "åˆå§‹åŒ–æ—è·¯ç”±æ¨¡å¼"
    
    if [ -n "$bin_nft" ]; then
        nft delete table inet znetcontrol 2>/dev/null || true
        
        nft add table inet znetcontrol
        
        nft add chain inet znetcontrol forward "{ type filter hook forward priority -100; policy accept; }"
        
        nft add chain inet znetcontrol input "{ type filter hook input priority -100; policy accept; }"
        
        info "æ—è·¯ç”±nftablesè¡¨å·²åˆ›å»º"
    fi
}

init_timecontrol() {
    detect_gateway_mode
    
    info "åˆå§‹åŒ–æ—¶é—´æ§åˆ¶ï¼ˆ$GATEWAY_MODE æ¨¡å¼ï¼‰"
    
    case "$GATEWAY_MODE" in
        "main")
            init_main_route
            ;;
        "bypass")
            init_bypass_route
            ;;
    esac
    
    info "åˆå§‹åŒ–å®Œæˆ"
}

main_route_timeadd() {
    local id=$1
    local target=$2
    local chain=$3
    local value=$4
    local display_name=$5
    
    if [ "$chain" = "input" ]; then
        nft add element bridge znetcontrol blacklist_mac_input "{ $value }" 2>/dev/null
        info "âœ… ã€$display_nameã€‘ä¸»è·¯ç”±-å¼ºåŠ›æ§åˆ¶ï¼šMAC $value"
    else
        nft add element bridge znetcontrol blacklist_mac_forward "{ $value }" 2>/dev/null
        info "âœ… ã€$display_nameã€‘ä¸»è·¯ç”±-æ™®é€šæ§åˆ¶ï¼šMAC $value"
    fi
}

bypass_route_timeadd() {
    local id=$1
    local target=$2
    local chain=$3
    local value=$4
    local display_name=$5
    
    info "ğŸ¯ ã€$display_nameã€‘æ—è·¯ç”±è§„åˆ™æ·»åŠ "
    
    local device_ip=$(get_device_ip "$value")
    
    # æ¸…ç†æ˜¾ç¤ºåç§°ä¸­çš„ç‰¹æ®Šå­—ç¬¦
    local safe_name=$(echo "$display_name" | sed 's/[^a-zA-Z0-9_-]/_/g' | cut -c1-20)
    
    if [ "$chain" = "input" ]; then
        # å¼ºåŠ›æ§åˆ¶ï¼šåŒæ—¶é™åˆ¶è®¿é—®è·¯ç”±å™¨å’Œå¤–ç½‘
        
        # 1. æ·»åŠ inputé“¾è§„åˆ™ï¼ˆé™åˆ¶è®¿é—®è·¯ç”±å™¨ï¼‰
        nft add rule inet znetcontrol input ether saddr "$value" drop comment "$safe_name-input"
        nft add rule inet znetcontrol input ether saddr "$value" log prefix "ZNET-INPUT: " level info
        
        # 2. æ·»åŠ forwardé“¾è§„åˆ™ï¼ˆé™åˆ¶è®¿é—®å¤–ç½‘ï¼‰
        nft add rule inet znetcontrol forward ether saddr "$value" drop comment "$safe_name-forward"
        nft add rule inet znetcontrol forward ether saddr "$value" log prefix "ZNET-FORWARD: " level info
        
        # 3. å¦‚æœè·å–åˆ°IPåœ°å€ï¼Œä¹Ÿæ·»åŠ IPè§„åˆ™
        if [ -n "$device_ip" ]; then
            nft add rule inet znetcontrol input ip saddr "$device_ip" drop
            nft add rule inet znetcontrol forward ip saddr "$device_ip" drop
            info "âœ… ã€$display_nameã€‘æ—è·¯ç”±-å¼ºåŠ›æ§åˆ¶ï¼šMAC+IPï¼ˆå†…å¤–ç½‘å…¨é™åˆ¶ï¼‰"
        else
            info "âœ… ã€$display_nameã€‘æ—è·¯ç”±-å¼ºåŠ›æ§åˆ¶ï¼šMACï¼ˆå†…å¤–ç½‘å…¨é™åˆ¶ï¼‰"
        fi
    else
        # æ™®é€šæ§åˆ¶ï¼šåªé™åˆ¶è®¿é—®å¤–ç½‘
        nft add rule inet znetcontrol forward ether saddr "$value" drop comment "$safe_name-forward"
        nft add rule inet znetcontrol forward ether saddr "$value" log prefix "ZNET-FORWARD: " level info
        nft add rule inet znetcontrol forward ether saddr "$value" counter
        
        if [ -n "$device_ip" ]; then
            nft add rule inet znetcontrol forward ip saddr "$device_ip" drop
            nft add rule inet znetcontrol forward ip saddr "$device_ip" log prefix "ZNET-IP: " level info
            info "âœ… ã€$display_nameã€‘æ—è·¯ç”±-æ™®é€šæ§åˆ¶ï¼šMAC+IP"
        else
            info "âœ… ã€$display_nameã€‘æ—è·¯ç”±-æ™®é€šæ§åˆ¶ï¼šMAC"
        fi
    fi
}

timeadd() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local chain=$(config_t_get device chain "$id" "forward")
    [ -z "$target" ] && return
    
    if [ -z "$GATEWAY_MODE" ]; then
        detect_gateway_mode
    fi
    
    local display_name=$(get_rule_display_name "$id")
    info "æ·»åŠ è®¾å¤‡æ§åˆ¶: ã€$display_nameã€‘($target)ï¼Œæ¨¡å¼: $GATEWAY_MODE"
    
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    case "$type" in
        "mac")
            value=$(echo "$value" | tr '[:upper:]' '[:lower:]')
            
            case "$GATEWAY_MODE" in
                "main")
                    main_route_timeadd "$id" "$target" "$chain" "$value" "$display_name"
                    ;;
                "bypass")
                    bypass_route_timeadd "$id" "$target" "$chain" "$value" "$display_name"
                    ;;
            esac
            ;;
            
        "ipv4")
            if [ "$GATEWAY_MODE" = "main" ]; then
                if [ "$chain" = "input" ]; then
                    nft add element ip znetcontrol blacklist_ip_input "{ $value }" 2>/dev/null
                else
                    nft add element ip znetcontrol blacklist_ip_forward "{ $value }" 2>/dev/null
                fi
                info "âœ… ã€$display_nameã€‘ä¸»è·¯ç”±-IPæ§åˆ¶ï¼š$value"
            else
                nft add rule inet znetcontrol forward ip saddr "$value" drop comment "$display_name-ip"
                info "âœ… ã€$display_nameã€‘æ—è·¯ç”±-IPæ§åˆ¶ï¼š$value"
            fi
            ;;
    esac
}

timedel() {
    local id=$1
    local target=$(config_t_get device target "$id")
    local name=$(config_t_get device name "$id")
    local chain=$(config_t_get device chain "$id" "forward")
    [ -z "$target" ] && return
    
    local display_name=$(get_rule_display_name "$id")
    
    local parsed_result=$(parse_target "$target")
    if [ $? -ne 0 ]; then
        dbg "æ— æ³•è§£æç›®æ ‡åœ°å€: $target"
        return
    fi
    
    IFS=':' read -r type subtype value <<< "$parsed_result"
    
    if [ -n "$bin_nft" ]; then
        case "$type" in
            "mac")
                value=$(echo "$value" | tr '[:upper:]' '[:lower:]')
                
                if [ "$GATEWAY_MODE" = "main" ]; then
                    if [ "$chain" = "input" ]; then
                        nft delete element bridge znetcontrol blacklist_mac_input "{ $value }" 2>/dev/null || true
                    else
                        nft delete element bridge znetcontrol blacklist_mac_forward "{ $value }" 2>/dev/null || true
                    fi
                else
                    # åˆ é™¤MACåœ°å€è§„åˆ™
                    nft delete rule inet znetcontrol forward handle $(nft -a list chain inet znetcontrol forward 2>/dev/null | grep "ether saddr $value" | awk '{print $NF}' | head -1) 2>/dev/null || true
                    nft delete rule inet znetcontrol input handle $(nft -a list chain inet znetcontrol input 2>/dev/null | grep "ether saddr $value" | awk '{print $NF}' | head -1) 2>/dev/null || true
                    
                    # åˆ é™¤å¯¹åº”çš„IPåœ°å€è§„åˆ™ï¼ˆå¦‚æœæœ‰ï¼‰
                    local device_ip=$(get_device_ip "$value")
                    if [ -n "$device_ip" ]; then
                        nft delete rule inet znetcontrol input handle $(nft -a list chain inet znetcontrol input 2>/dev/null | grep "ip saddr $device_ip" | awk '{print $NF}' | head -1) 2>/dev/null || true
                        nft delete rule inet znetcontrol forward handle $(nft -a list chain inet znetcontrol forward 2>/dev/null | grep "ip saddr $device_ip" | awk '{print $NF}' | head -1) 2>/dev/null || true
                        info "âœ… ã€$display_nameã€‘ä»é˜²ç«å¢™ç§»é™¤: MAC $value å’Œ IP $device_ip"
                    else
                        info "âœ… ã€$display_nameã€‘ä»é˜²ç«å¢™ç§»é™¤: $value"
                    fi
                fi
                ;;
            "ipv4")
                if [ "$GATEWAY_MODE" = "main" ]; then
                    if [ "$chain" = "input" ]; then
                        nft delete element ip znetcontrol blacklist_ip_input "{ $value }" 2>/dev/null || true
                    else
                        nft delete element ip znetcontrol blacklist_ip_forward "{ $value }" 2>/dev/null || true
                    fi
                else
                    # åˆ é™¤IPv4åœ°å€è§„åˆ™ï¼ˆinputå’Œforwardé“¾ï¼‰
                    nft delete rule inet znetcontrol forward handle $(nft -a list chain inet znetcontrol forward 2>/dev/null | grep "ip saddr $value" | awk '{print $NF}' | head -1) 2>/dev/null || true
                    nft delete rule inet znetcontrol input handle $(nft -a list chain inet znetcontrol input 2>/dev/null | grep "ip saddr $value" | awk '{print $NF}' | head -1) 2>/dev/null || true
                fi
                info "âœ… ã€$display_nameã€‘ä»é˜²ç«å¢™ç§»é™¤: $value"
                ;;
        esac
    fi
}

show_status() {
    echo ""
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚           ZNetControl ç³»ç»ŸçŠ¶æ€             â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    if [ -z "$GATEWAY_MODE" ]; then
        detect_gateway_mode
    fi
    
    if [ "$GATEWAY_MODE" = "bypass" ]; then
        echo "â”‚    è¿è¡Œæ¨¡å¼: æ—è·¯ç”±æ¨¡å¼                    â”‚"
        echo "â”‚    ç½‘å…³: ${BYPASS_GATEWAY:-æœªçŸ¥}          â”‚"
    else
        echo "â”‚    è¿è¡Œæ¨¡å¼: ä¸»è·¯ç”±æ¨¡å¼                    â”‚"
    fi
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
   
    echo "â”‚ å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')       â”‚"
    
    case $(date '+%u') in
        1) weekday="æ˜ŸæœŸä¸€" ;;
        2) weekday="æ˜ŸæœŸäºŒ" ;;
        3) weekday="æ˜ŸæœŸä¸‰" ;;
        4) weekday="æ˜ŸæœŸå››" ;;
        5) weekday="æ˜ŸæœŸäº”" ;;
        6) weekday="æ˜ŸæœŸå…­" ;;
        7) weekday="æ˜ŸæœŸæ—¥" ;;
        *) weekday="æœªçŸ¥" ;;
    esac
    echo "â”‚ æ˜ŸæœŸ: $weekday                               â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    
    # ä¿®å¤é…ç½®è§„åˆ™æ•°ç»Ÿè®¡
    local config_count=0
    if [ -f "/etc/config/znetcontrol" ]; then
        config_count=$(uci show znetcontrol 2>/dev/null | grep -c '@device' || echo 0)
    fi
    
    # ä¿®å¤ç”Ÿæ•ˆè§„åˆ™æ•°ç»Ÿè®¡
    local active_count=0
    if [ -f "$IDLIST" ] && [ -s "$IDLIST" ]; then
        active_count=$(tr -cd '!' < "$IDLIST" 2>/dev/null | wc -c || echo 0)
        # æˆ–è€…ä½¿ç”¨ï¼šactive_count=$(grep -o '!' "$IDLIST" 2>/dev/null | wc -l || echo 0)
    fi
    
    echo "â”‚ é…ç½®è§„åˆ™æ•°: $config_count ä¸ª                 â”‚"
    echo "â”‚ ç”Ÿæ•ˆè§„åˆ™æ•°: $active_count ä¸ª                 â”‚"
    
    if [ "$active_count" -gt 0 ]; then
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚ å½“å‰æ§åˆ¶ä¸­çš„è®¾å¤‡:                          â”‚"
        
        tr '!' '\n' < "$IDLIST" 2>/dev/null | grep -v '^$' | while read id; do
            if [ -n "$id" ]; then
                local name=$(config_t_get device name "$id" 2>/dev/null || echo "è§„åˆ™$id")
                local target=$(config_t_get device target "$id" 2>/dev/null || echo "æœªçŸ¥")
                local chain=$(config_t_get device chain "$id" 2>/dev/null || echo "forward")
                
                # ç®€åŒ–æ˜¾ç¤ºï¼Œç¡®ä¿ä¸ä¼šè¶…å‡ºè¾¹ç•Œ
                name=$(echo "$name" | cut -c1-10)
                target=$(echo "$target" | cut -c1-13)
                
                if [ "$chain" = "input" ]; then
                    printf "â”‚   ğŸ”’ %-10s - %-13s      â”‚\n" "$name" "$target"
                else
                    printf "â”‚   ğŸ”— %-10s - %-13s      â”‚\n" "$name" "$target"
                fi
            fi
        done
    fi
    
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ nftablesçŠ¶æ€:                              â”‚"
    
    if [ "$GATEWAY_MODE" = "bypass" ]; then
        # ä¿®å¤è§„åˆ™æ•°ç»Ÿè®¡
        local rule_count=0
        if nft list table inet znetcontrol 2>/dev/null >/dev/null; then
            rule_count=$(nft list table inet znetcontrol 2>/dev/null | grep -c "drop comment" || echo 0)
        fi
        echo "â”‚   è§„åˆ™æ•°: $rule_count æ¡                          â”‚"
    else
        local bridge_count=0
        local ip_count=0
        if nft list table bridge znetcontrol 2>/dev/null >/dev/null; then
            bridge_count=$(nft list table bridge znetcontrol 2>/dev/null | grep -c "drop comment" || echo 0)
        fi
        if nft list table ip znetcontrol 2>/dev/null >/dev/null; then
            ip_count=$(nft list table ip znetcontrol 2>/dev/null | grep -c "drop comment" || echo 0)
        fi
        echo "â”‚   Bridgeè§„åˆ™: $bridge_count æ¡                      â”‚"
        echo "â”‚   IPè§„åˆ™: $ip_count æ¡                          â”‚"
    fi
    
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
}

stop_timecontrol() {
    info "åœæ­¢æ—¶é—´æ§åˆ¶æœåŠ¡"
    
    # å…ˆåœæ­¢ç›‘æ§è¿›ç¨‹
    if [ -f "/var/run/znetcontrol.pid" ]; then
        local pid=$(cat /var/run/znetcontrol.pid 2>/dev/null)
        if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
            kill -TERM "$pid" 2>/dev/null
            sleep 1
            kill -KILL "$pid" 2>/dev/null 2>&1
        fi
    fi
    
    # æ¸…ç†é˜²ç«å¢™è§„åˆ™ï¼ˆæ·»åŠ è¶…æ—¶ï¼‰
    if [ -n "$bin_nft" ]; then
        local timeout=5
        if [ "$GATEWAY_MODE" = "main" ]; then
            timeout nft delete table ip znetcontrol 2>/dev/null && info "å·²æ¸…ç†IPv4è¡¨"
            timeout nft delete table ip6 znetcontrol 2>/dev/null && info "å·²æ¸…ç†IPv6è¡¨"
            timeout nft delete table bridge znetcontrol 2>/dev/null && info "å·²æ¸…ç†bridgeè¡¨"
        else
            timeout nft delete table inet znetcontrol 2>/dev/null && info "å·²æ¸…ç†inetè¡¨"
        fi
    fi
    
    # æ¸…ç†æ–‡ä»¶
    rm -rf "$IDLIST" "$TMPID" /var/run/znetcontrol.pid 2>/dev/null
    info "æ‰€æœ‰è§„åˆ™å·²æ¸…é™¤"
}

show_help() {
    echo "ZNetControl ä¸Šç½‘æ—¶é—´æ§åˆ¶ç³»ç»Ÿ"
    echo ""
    echo "æ”¯æŒçš„åœ°å€æ ¼å¼:"
    echo "  1. å•ä¸ªIP: 192.168.1.100"
    echo "  2. IPèŒƒå›´: 192.168.1.1-192.168.1.100"
    echo "  3. CIDR: 192.168.1.0/24"
    echo "  4. MACåœ°å€: 00:11:22:33:44:55"
    echo ""
    echo "ç”¨æ³•: $0 {start|stop|add <id>|del <id>|status|help}"
    echo ""
    echo "é…ç½®: ç¼–è¾‘ /etc/config/znetcontrol"
    echo "æ—¥å¿—: æŸ¥çœ‹ /var/log/znetcontrol.log"
}

if [ -x "$bin_nft" ]; then
    nftables_ver="true"
    dbg "nft found: $bin_nft"
elif [ -x "$bin_iptables" ] || [ -x "$bin_ip6tables" ]; then
    iptables_ver="true"
    dbg "iptables found: $bin_iptables"
else
    dbg "No firewall tool found!"
    exit 1
fi

CHAIN=$(uci -q get znetcontrol.settings.chain || echo "forward")
list_type=$(uci -q get znetcontrol.settings.control_mode || echo "blacklist")

case "$crrun" in
    "start")
        stop_timecontrol
        echo -e "\n====== å¯åŠ¨ ZNetControl ======" >> "$LOG_FILE"
        mkdir -p /var/log /var/run 2>/dev/null
        touch "$IDLIST" 2>/dev/null
        
        info "ä»é…ç½®æ–‡ä»¶åŠ è½½è§„åˆ™..."
        
        enabled_ids=$(get_enabled_rule_ids)
        info "å‘ç°å¯ç”¨è§„åˆ™: $(echo $enabled_ids | wc -w) ä¸ª"
        
        init_timecontrol
        
        if [ -n "$enabled_ids" ]; then
            for id in $enabled_ids; do
                display_name=$(get_rule_display_name "$id")
                info "å¤„ç†ã€$display_nameã€‘"
                
                if check_list "$id"; then
                    timeadd "$id"
                    echo "!${id}!" >> "$IDLIST"
                    info "âœ… ã€$display_nameã€‘å·²æ·»åŠ åˆ°æ§åˆ¶åˆ—è¡¨"
                else
                    info "â° ã€$display_nameã€‘ä¸åœ¨ç”Ÿæ•ˆæ—¶é—´"
                fi
            done
        else
            info "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨è§„åˆ™"
        fi
        
        info "æ—¶é—´æ§åˆ¶å¯åŠ¨å®Œæˆï¼Œæ§åˆ¶ $(wc -l < "$IDLIST" 2>/dev/null || echo 0) ä¸ªè®¾å¤‡"
        show_status
        ;;
        
    "stop")
        info "åœæ­¢æ—¶é—´æ§åˆ¶æœåŠ¡"
        stop_timecontrol
        info "æ‰€æœ‰é˜²ç«å¢™è§„åˆ™å·²æ¸…é™¤"
        ;;
        
    "add")
        info "æ·»åŠ è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            display_name=$(get_rule_display_name "$list")
            
            if check_list "$list"; then
                timeadd "$list"
                if ! grep -q "!$list!" "$IDLIST"; then
                    echo "!$list!" >> "$IDLIST"
                fi
                info "ã€$display_nameã€‘å·²æ·»åŠ "
            else
                if grep -q "!${list}!" "$IDLIST"; then
                    timedel "$list"
                    sed -i "/!$list!/d" "$IDLIST"
                    info "ã€$display_nameã€‘å·²ç§»é™¤"
                fi
            fi
        done
        ;;
        
    "del")
        info "ç§»é™¤è®¾å¤‡æ§åˆ¶"
        for list in $(echo "$crid" | sed -e 's/!//g' | sed 's/,/ /g'); do
            display_name=$(get_rule_display_name "$list")
            
            timedel "$list"
            sed -i "/!$list!/d" "$IDLIST"
            info "ã€$display_nameã€‘å·²åˆ é™¤"
        done
        ;;
        
    "status")
        show_status
        ;;
        
    "help"|"")
        show_help
        ;;
        
    *)
        dbg "æ— æ•ˆå‘½ä»¤: $crrun"
        show_help
        exit 1
        ;;
esac


