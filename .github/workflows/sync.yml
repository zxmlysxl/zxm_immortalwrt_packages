- name: Atomic Sync (Guaranteed Local Change Preservation)
  run: |
    # å®‰è£…å¿…è¦å·¥å…·
    sudo apt-get -y install parallel jq rsync tree

    # å®šä¹‰ä»“åº“åˆ—è¡¨ï¼ˆä¿æŒæ‚¨çš„é…ç½®ï¼‰
    REPOS='[
            {"url":"https://github.com/sirpdboy/luci-app-advancedplus.git","dest":"luci-app-advancedplus","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-theme-kucat.git","dest":"kucat","branch":"js"},
            {"url":"https://github.com/sirpdboy/luci-app-kucat-config.git","dest":"kucat-config","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-chatgpt-web.git","dest":"luci-app-chatgpt-web","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netwizard.git","dir":"luci-app-netwizard","dest":"luci-app-netwizard","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netspeedtest.git","dest":"netspeedtest","branch":"js"},
            {"url":"https://github.com/sirpdboy/luci-app-netdata.git","dest":"luci-app-netdata","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-timecontrol.git","dir":"luci-app-nft-timecontrol","dest":"luci-app-nft-timecontrol","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-eqosplus.git","dest":"luci-app-eqosplus","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-watchdog.git","dest":"watchdog","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-taskplan.git","dir":"luci-app-taskplan","dest":"luci-app-taskplan","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-poweroffdevice.git","dir":"luci-app-poweroffdevice","dest":"luci-app-poweroffdevice","branch":"js"},
            {"url":"https://github.com/tty228/luci-app-wechatpush.git","dest":"luci-app-wechatpush","branch":"master"},
            {"url":"https://github.com/gdy666/luci-app-lucky.git","dest":"lucky","branch":"main"},
            {"url":"https://github.com/EasyTier/luci-app-easytier.git","dest":"easytier","branch":"main"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-nikki.git","dest":"nikki","branch":"main"},
            {"url":"https://github.com/animegasan/luci-app-wolplus.git","dest":"luci-app-wolplus","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall.git","dir":"luci-app-passwall","dest":"luci-app-passwall","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall2.git","dir":"luci-app-passwall2","dest":"luci-app-passwall2","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall-packages.git","dest":"openwrt-passwall-packages","branch":"main"},
            {"url":"https://github.com/linkease/istore.git","dest":"istore","branch":"main"}
          ]'

    # ç»ˆæç‰ˆåŒæ­¥å‡½æ•°ï¼ˆç¡®ä¿ä¸è¦†ç›–ä»»ä½•æœ¬åœ°ä¿®æ”¹ï¼‰
    atomic_sync() {
      local repo=$1
      local url=$(jq -r '.url' <<< "$repo")
      local dest=$(jq -r '.dest' <<< "$repo")
      local branch=$(jq -r '.branch' <<< "$repo")
      local dir=$(jq -r '.dir // empty' <<< "$repo")
      local temp_dir=$(mktemp -d)
      
      echo "ğŸ” å¼€å§‹åŒæ­¥ [$dest] (åˆ†æ”¯: $branch)"

      # å…‹éš†ä¸Šæ¸¸ä»“åº“ï¼ˆå«é‡è¯•é€»è¾‘ï¼‰
      for i in $(seq 1 $GIT_RETRIES); do
        if git clone --depth 1 --branch "$branch" "$url" "$temp_dir"; then
          break
        elif [ $i -eq $GIT_RETRIES ]; then
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯•é»˜è®¤åˆ†æ”¯"
          git clone --depth 1 "$url" "$temp_dir" || return 1
          cd "$temp_dir"
          branch=$(git rev-parse --abbrev-ref origin/HEAD | cut -d'/' -f2)
          git checkout "$branch"
          cd -
        else
          sleep $((i * 5))
        fi
      done

      # æ£€æµ‹æ‰€æœ‰æœ¬åœ°å˜æ›´ï¼ˆå…³é”®æ”¹è¿›ç‚¹ï¼‰
      local exclude_patterns=()
      if [ -d "$dest" ]; then
        cd "$dest"
        # ä½¿ç”¨ git + find ç¡®ä¿æ•è·æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªæ–‡ä»¶ï¼‰
        while IFS= read -r file; do
          # è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆå…¼å®¹å­ç›®å½•åŒæ­¥ï¼‰
          rel_path="${file#./}"
          if [[ -d "$file" ]]; then
            exclude_patterns+=("--exclude=/${rel_path}/")
            exclude_patterns+=("--exclude=/${rel_path}/*")
          else
            exclude_patterns+=("--exclude=/${rel_path}")
          fi
        done < <(git ls-files --modified --others --exclude-standard && \
                 find . -type f ! -path '*/.git/*' ! -path './.git' | grep -vFx "$(git ls-files)")
        cd -
      fi

      # æ‰“å°æ’é™¤è§„åˆ™ï¼ˆè°ƒè¯•ç”¨ï¼‰
      echo "â„¹ï¸ æ’é™¤è§„åˆ™:"
      printf '  %s\n' "${exclude_patterns[@]}" | sort | uniq

      # æ‰§è¡ŒåŒæ­¥ï¼ˆå…³é”®ï¼šä½¿ç”¨ / å¼€å¤´çš„æ’é™¤è·¯å¾„ï¼‰
      mkdir -p "$dest"
      if [ -n "$dir" ]; then
        echo "ğŸ”„ åŒæ­¥å­ç›®å½•: $dir"
        if [ -d "$temp_dir/$dir" ]; then
          rsync -av --delete --exclude='.git' \
            "${exclude_patterns[@]}" \
            "$temp_dir/$dir/" "$dest/"
        else
          echo "âŒ å­ç›®å½•ä¸å­˜åœ¨: $dir"
          return 1
        fi
      else
        rsync -av --delete --exclude='.git' \
          "${exclude_patterns[@]}" \
          "$temp_dir/" "$dest/"
      fi

      echo "âœ… åŒæ­¥å®Œæˆ [$dest] (å·²ä¿æŠ¤ ${#exclude_patterns[@]} å¤„æœ¬åœ°å˜æ›´)"
      rm -rf "$temp_dir"
    }
    export -f atomic_sync

    # å¹¶è¡Œæ‰§è¡ŒåŒæ­¥
    echo "$REPOS" | jq -c '.[]' | parallel -j 4 --halt soon,fail=1 atomic_sync
