name: Z-autorepo
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤2ï¼šè®¾ç½®ç¯å¢ƒå’Œä¾èµ–
      - name: Setup Environment
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1

          echo "ğŸ”§ å®‰è£…ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y parallel jq rsync curl

          # é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global http.postBuffer 524288000

          echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"

      # æ­¥éª¤3ï¼šä»“åº“å¥åº·æ£€æŸ¥
      - name: Repository Health Check
        id: health-check
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1

          # ä»“åº“é…ç½®åˆ—è¡¨
          REPOS='[
            {"url":"https://github.com/sirpdboy/luci-app-advancedplus.git","dest":"luci-app-advancedplus","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-adguardhome.git","dir":"luci-app-adguardhome","dest":"luci-app-adguardhome","branch":"lua"},
            {"url":"https://github.com/sirpdboy/luci-theme-kucat.git","dest":"luci-theme-kucat","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-kucat-config.git","dest":"luci-app-kucat-config","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-chatgpt-web.git","dest":"luci-app-chatgpt-web","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netwizard.git","dir":"luci-app-netwizard","dest":"luci-app-netwizard","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netspeedtest.git","dest":"netspeedtest","branch":"js"},
            {"url":"https://github.com/sirpdboy/luci-app-watchdog.git","dest":"watchdog","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-taskplan.git","dir":"luci-app-taskplan","dest":"luci-app-taskplan","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-timecontrol.git","dir":"luci-app-timecontrol","dest":"luci-app-timecontrol","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-poweroffdevice.git","dir":"luci-app-poweroffdevice","dest":"luci-app-poweroffdevice","branch":"js"},
            {"url":"https://github.com/tty228/luci-app-wechatpush.git","dest":"luci-app-wechatpush","branch":"master"},
            {"url":"https://github.com/gdy666/luci-app-lucky.git","dest":"lucky","branch":"main"},
            {"url":"https://github.com/EasyTier/luci-app-easytier.git","dest":"easytier","branch":"main"},
            {"url":"https://github.com/asvow/luci-app-tailscale.git","dest":"luci-app-tailscale","branch":"main"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-nikki.git","dest":"nikki","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall-packages.git","dest":"openwrt-passwall-packages","branch":"main"},
            {"url":"https://github.com/sos801107/luci-app-ota.git","dest":"luci-app-ota","branch":"main"},
            {"url":"https://github.com/brvphoenix/luci-app-wrtbwmon.git","dir":"luci-app-wrtbwmon","dest":"luci-app-wrtbwmon","branch":"master"},
            {"url":"https://github.com/brvphoenix/wrtbwmon.git","dir":"wrtbwmon","dest":"wrtbwmon","branch":"new"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-momo.git","dir":"luci-app-momo","dest":"luci-app-momo","branch":"main"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-momo.git","dir":"momo","dest":"momo","branch":"main"},
            {"url":"https://github.com/vernesong/OpenClash.git","dir":"luci-app-openclash","dest":"luci-app-openclash","branch":"master"},
            {"url":"https://github.com/linkease/istore.git","dest":"istore","branch":"main"}
          ]'

          # æ£€æŸ¥ä»“åº“å¥åº·çŠ¶æ€
          check_repo_health() {
            local repo=$1
            local url=$(echo "$repo" | jq -r '.url // empty')
            local dest=$(echo "$repo" | jq -r '.dest // empty')
            
            if [ -z "$url" ]; then
              echo "âŒ $dest - URL ä¸ºç©º"
              return 1
            fi
            
            local repo_path=${url#https://github.com/}
            repo_path=${repo_path%.git}
            
            # ä½¿ç”¨ GitHub API æ£€æŸ¥ä»“åº“çŠ¶æ€
            local response_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$repo_path")
            
            if [ "$response_code" = "200" ]; then
              echo "âœ… $dest - å¥åº·"
              echo "$repo" >> healthy_repos.jsonl
              return 0
            elif [ "$response_code" = "404" ]; then
              echo "âŒ $dest - ä»“åº“ä¸å­˜åœ¨ (404)"
              echo "$repo" >> problematic_repos.jsonl
              return 1
            elif [ "$response_code" = "403" ]; then
              echo "âš ï¸ $dest - è®¿é—®å—é™ (403)ï¼Œä½†ä»å°è¯•åŒæ­¥"
              echo "$repo" >> healthy_repos.jsonl
              return 0
            else
              echo "âš ï¸ $dest - çŠ¶æ€æœªçŸ¥ ($response_code)ï¼Œä½†ä»å°è¯•åŒæ­¥"
              echo "$repo" >> healthy_repos.jsonl
              return 0
            fi
          }
          export -f check_repo_health

          # åˆå§‹åŒ–æ–‡ä»¶
          > healthy_repos.jsonl
          > problematic_repos.jsonl

          echo "ğŸ” å¼€å§‹ä»“åº“å¥åº·æ£€æŸ¥..."
          echo "$REPOS" | jq -c '.[]' | parallel -j 5 check_repo_health

          # ç”ŸæˆæŠ¥å‘Š
          healthy_count=$(wc -l < healthy_repos.jsonl 2>/dev/null || echo 0)
          problematic_count=$(wc -l < problematic_repos.jsonl 2>/dev/null || echo 0)
          total_count=$(echo "$REPOS" | jq 'length')

          echo "ğŸ“Š å¥åº·æ£€æŸ¥æŠ¥å‘Š:"
          echo "   æ€»ä»“åº“æ•°: $total_count"
          echo "   å¥åº·ä»“åº“: $healthy_count"
          echo "   é—®é¢˜ä»“åº“: $problematic_count"

          # è¾“å‡ºé—®é¢˜ä»“åº“è¯¦æƒ…
          if [ $problematic_count -gt 0 ]; then
            echo "ğŸš« é—®é¢˜ä»“åº“åˆ—è¡¨:"
            while IFS= read -r repo; do
              local dest=$(echo "$repo" | jq -r '.dest')
              local url=$(echo "$repo" | jq -r '.url')
              echo "   - $dest: $url"
            done < problematic_repos.jsonl
          fi

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "healthy_count=$healthy_count" >> $GITHUB_OUTPUT
          echo "problematic_count=$problematic_count" >> $GITHUB_OUTPUT
          echo "total_count=$total_count" >> $GITHUB_OUTPUT

      # æ­¥éª¤4ï¼šæ‰§è¡Œæ™ºèƒ½åŒæ­¥
      - name: Run Smart Sync
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1

          # å¢å¼ºçš„æ™ºèƒ½åŒæ­¥å‡½æ•°
          smart_sync() {
            local repo=$1
            
            local url=$(echo "$repo" | jq -r '.url // empty')
            local dest=$(echo "$repo" | jq -r '.dest // empty')
            local branch=$(echo "$repo" | jq -r '.branch // "main"')
            local dir=$(echo "$repo" | jq -r '.dir // empty')
            
            # éªŒè¯å¿…è¦å­—æ®µ
            if [ -z "$url" ] || [ -z "$dest" ]; then
              echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å­—æ®µ (url æˆ– dest)ï¼Œè·³è¿‡"
              return 0
            fi
            
            echo "ğŸ” æ­£åœ¨åŒæ­¥ [$dest] (åˆ†æ”¯: $branch)"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            temp_dir=$(mktemp -d)
            
            # å…‹éš†ä»“åº“ï¼ˆå¸¦æ™ºèƒ½é‡è¯•ï¼‰
            local max_retries=3
            local clone_success=false
            
            for i in $(seq 1 $max_retries); do
              echo "   å°è¯•å…‹éš† (ç¬¬ $i/$max_retries æ¬¡)..."
              
              if git clone --depth 1 --branch "$branch" "$url" "$temp_dir" 2>&1; then
                echo "   âœ… å…‹éš†æˆåŠŸ"
                clone_success=true
                break
              else
                echo "   âŒ å…‹éš†å¤±è´¥"
                if [ $i -eq $max_retries ]; then
                  echo "   ğŸ’¡ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè·³è¿‡ä»“åº“"
                  rm -rf "$temp_dir"
                  return 0
                fi
                sleep 10
              fi
            done
            
            # å¦‚æœå…‹éš†æˆåŠŸï¼Œæ‰§è¡ŒåŒæ­¥
            if [ "$clone_success" = true ] && [ -d "$temp_dir" ] && [ -n "$(ls -A "$temp_dir" 2>/dev/null)" ]; then
              local source_path="$temp_dir"
              if [ -n "$dir" ] && [ -d "$temp_dir/$dir" ]; then
                source_path="$temp_dir/$dir"
                echo "   ä½¿ç”¨å­ç›®å½•: $dir"
              elif [ -n "$dir" ]; then
                echo "   âš ï¸ æŒ‡å®šç›®å½• '$dir' ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ ¹ç›®å½•"
              fi
              
              # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶åŒæ­¥
              mkdir -p "$dest"
              echo "   æ‰§è¡ŒåŒæ­¥: $source_path/ -> $dest/"
              
              if rsync -av --delete \
                   --exclude=".git*" \
                   --exclude=".github" \
                   --exclude=".gitignore" \
                   "$source_path/" "$dest/" 2>&1; then
                echo "   âœ… åŒæ­¥å®Œæˆ [$dest]"
                sync_success=true
              else
                echo "   âŒ åŒæ­¥å¤±è´¥ [$dest]"
                sync_success=false
              fi
            else
              echo "   âŒ å…‹éš†åç›®å½•ä¸ºç©ºï¼Œè·³è¿‡åŒæ­¥"
              sync_success=false
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$temp_dir"
            
            if [ "$sync_success" = true ]; then
              return 0
            else
              return 0  # å³ä½¿å¤±è´¥ä¹Ÿè¿”å› 0ï¼Œä¸ä¸­æ–­å…¶ä»–ä»“åº“åŒæ­¥
            fi
          }
          export -f smart_sync

          echo "ğŸš€ å¼€å§‹åŒæ­¥å¥åº·ä»“åº“..."
          
          # åªåŒæ­¥å¥åº·ä»“åº“
          if [ -f healthy_repos.jsonl ] && [ -s healthy_repos.jsonl ]; then
            cat healthy_repos.jsonl | parallel -j 3 --halt soon,fail=0 smart_sync
            echo "âœ… æ‰€æœ‰å¥åº·ä»“åº“åŒæ­¥å®Œæˆ"
          else
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¥åº·ä»“åº“ï¼Œè·³è¿‡åŒæ­¥"
          fi

          # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
          echo "ğŸ“‹ åŒæ­¥æ€»ç»“:"
          echo "   æˆåŠŸåŒæ­¥: $(find . -maxdepth 2 -type f -name "*.lua" -o -name "*.js" -o -name "*.md" 2>/dev/null | grep -v ".git" | wc -l) ä¸ªæ–‡ä»¶"

      # æ­¥éª¤5ï¼šæäº¤å˜æ›´
      - name: Commit and Push Changes
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1
          
          # é…ç½® Git ç”¨æˆ·
          git config --global user.name "zxmlysxl"
          git config --global user.email "zxmlysxl@gmail.com"
          
          # æ£€æŸ¥å˜æ›´
          if git status --porcelain | grep -q .; then
            echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æ˜¾ç¤ºå˜æ›´æ¦‚è¦
            echo "å˜æ›´æ–‡ä»¶:"
            git status --porcelain | sed 's/^/   /'
            
            # æ·»åŠ å¹¶æäº¤
            git add .
            git commit -m "chore: auto-sync repositories $(date +'%Y-%m-%d %H:%M:%S') [skip ci]"
            
            # æ¨é€å˜æ›´
            if git push; then
              echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–æœ€æ–°å˜æ›´åé‡è¯•"
              git pull --rebase
              git push
            fi
          else
            echo "ğŸŸ¢ æ— å˜æ›´éœ€è¦æäº¤"
          fi

      # æ­¥éª¤6ï¼šç”ŸæˆåŒæ­¥æŠ¥å‘Š
      - name: Generate Sync Report
        if: always()
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1
          
          # è¯»å–ç»Ÿè®¡ä¿¡æ¯
          HEALTHY_COUNT=$(cat healthy_repos.jsonl 2>/dev/null | wc -l || echo 0)
          PROBLEMATIC_COUNT=$(cat problematic_repos.jsonl 2>/dev/null | wc -l || echo 0)
          TOTAL_COUNT=$((HEALTHY_COUNT + PROBLEMATIC_COUNT))
          
          echo "## ğŸ”„ è‡ªåŠ¨åŒæ­¥æŠ¥å‘Š" > sync_report.md
          echo "" >> sync_report.md
          echo "**åŒæ­¥æ—¶é—´:** $(date)" >> sync_report.md
          echo "" >> sync_report.md
          echo "### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> sync_report.md
          echo "- æ€»ä»“åº“æ•°: $TOTAL_COUNT" >> sync_report.md
          echo "- æˆåŠŸåŒæ­¥: $HEALTHY_COUNT" >> sync_report.md
          echo "- è·³è¿‡ä»“åº“: $PROBLEMATIC_COUNT" >> sync_report.md
          echo "" >> sync_report.md
          
          if [ -f problematic_repos.jsonl ] && [ -s problematic_repos.jsonl ]; then
            echo "### ğŸš« è·³è¿‡çš„ä»“åº“" >> sync_report.md
            while IFS= read -r repo; do
              local dest=$(echo "$repo" | jq -r '.dest')
              local url=$(echo "$repo" | jq -r '.url')
              echo "- $dest: $url" >> sync_report.md
            done < problematic_repos.jsonl
          fi
          
          echo "" >> sync_report.md
          echo "---" >> sync_report.md
          echo "*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*" >> sync_report.md
          
          echo "ğŸ“„ åŒæ­¥æŠ¥å‘Šå†…å®¹:"
          cat sync_report.md
