name: Z-autorepo
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Smart Sync
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1
          
          echo "ğŸ”§ å®‰è£…ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y parallel jq rsync curl

          # åˆ›å»ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
          echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "Git çŠ¶æ€: $(git status --porcelain | wc -l) ä¸ªå˜æ›´"
          echo "å·¥å…·ç‰ˆæœ¬:"
          which jq && jq --version || echo "jq æœªå®‰è£…"
          which parallel && parallel --version || echo "parallel æœªå®‰è£…"
          which rsync && rsync --version | head -1 || echo "rsync æœªå®‰è£…"

      - name: Run Smart Sync
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1

          # æ”¹è¿›çš„æ™ºèƒ½åŒæ­¥å‡½æ•°ï¼ŒåŒ…å«æ›´å¥½çš„é”™è¯¯å¤„ç†
          smart_sync() {
            local repo=$1
            echo "=== å¼€å§‹å¤„ç†ä»“åº“ ==="
            echo "åŸå§‹æ•°æ®: $repo"
            
            # å®‰å…¨åœ°è§£æ JSON å­—æ®µ
            local url=$(echo "$repo" | jq -r '.url // empty')
            local dest=$(echo "$repo" | jq -r '.dest // empty')
            local branch=$(echo "$repo" | jq -r '.branch // "main"')
            local dir=$(echo "$repo" | jq -r '.dir // empty')
            
            # éªŒè¯å¿…è¦å­—æ®µ
            if [ -z "$url" ] || [ -z "$dest" ]; then
              echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å­—æ®µ (url æˆ– dest)"
              return 1
            fi
            
            echo "ğŸ” æ­£åœ¨åŒæ­¥ [$dest] (åˆ†æ”¯: $branch, ç›®å½•: ${dir:-æ ¹ç›®å½•})"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            temp_dir=$(mktemp -d)
            echo "ä¸´æ—¶ç›®å½•: $temp_dir"
            
            # å…‹éš†ä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            for i in {1..3}; do
              echo "å°è¯•å…‹éš† (ç¬¬ $i æ¬¡)..."
              if git clone --depth 1 --branch "$branch" "$url" "$temp_dir" 2>&1; then
                break
              fi
              if [ $i -eq 3 ]; then
                echo "âŒ å…‹éš†å¤±è´¥: $url"
                rm -rf "$temp_dir"
                return 1
              fi
              sleep 5
            done
            
            # æ£€æŸ¥å…‹éš†çš„ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$temp_dir" ]; then
              echo "âŒ ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨"
              return 1
            fi
            
            echo "å…‹éš†æˆåŠŸï¼Œç›®å½•å†…å®¹:"
            ls -la "$temp_dir"
            
            # æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
            local source_path="$temp_dir"
            if [ -n "$dir" ]; then
              source_path="$temp_dir/$dir"
              if [ ! -d "$source_path" ]; then
                echo "âŒ æºç›®å½•ä¸å­˜åœ¨: $source_path"
                ls -la "$temp_dir"
                rm -rf "$temp_dir"
                return 1
              fi
            fi
            
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p "$dest"
            
            # æ‰§è¡ŒåŒæ­¥
            echo "æ‰§è¡ŒåŒæ­¥: $source_path/ -> $dest/"
            if rsync -av --delete "$source_path/" "$dest/" 2>&1; then
              echo "âœ… åŒæ­¥å®Œæˆ [$dest]"
            else
              echo "âŒ åŒæ­¥å¤±è´¥ [$dest]"
              rm -rf "$temp_dir"
              return 1
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$temp_dir"
            return 0
          }
          export -f smart_sync

          # ä»“åº“é…ç½®åˆ—è¡¨
          REPOS='[
            {"url":"https://github.com/sirpdboy/luci-app-advancedplus.git","dest":"luci-app-advancedplus","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-adguardhome.git","dir":"luci-app-adguardhome","dest":"luci-app-adguardhome","branch":"lua"},
            {"url":"https://github.com/sirpdboy/luci-theme-kucat.git","dest":"kucat","branch":"js"},
            {"url":"https://github.com/sirpdboy/luci-app-chatgpt-web.git","dest":"luci-app-chatgpt-web","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netwizard.git","dir":"luci-app-netwizard","dest":"luci-app-netwizard","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-netspeedtest.git","dest":"netspeedtest","branch":"js"},
            {"url":"https://github.com/sirpdboy/luci-app-watchdog.git","dest":"watchdog","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-taskplan.git","dir":"luci-app-taskplan","dest":"luci-app-taskplan","branch":"master"},
            {"url":"https://github.com/sirpdboy/luci-app-timecontrol.git","dir":"luci-app-nft-timecontrol","dest":"luci-app-nft-timecontrol","branch":"main"},
            {"url":"https://github.com/sirpdboy/luci-app-poweroffdevice.git","dir":"luci-app-poweroffdevice","dest":"luci-app-poweroffdevice","branch":"js"},
            {"url":"https://github.com/tty228/luci-app-wechatpush.git","dest":"luci-app-wechatpush","branch":"master"},
            {"url":"https://github.com/gdy666/luci-app-lucky.git","dest":"lucky","branch":"main"},
            {"url":"https://github.com/EasyTier/luci-app-easytier.git","dest":"easytier","branch":"main"},
            {"url":"https://github.com/asvow/luci-app-tailscale.git","dest":"luci-app-tailscale","branch":"main"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-nikki.git","dest":"nikki","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall.git","dir":"luci-app-passwall","dest":"luci-app-passwall","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall2.git","dir":"luci-app-passwall2","dest":"luci-app-passwall2","branch":"main"},
            {"url":"https://github.com/xiaorouji/openwrt-passwall-packages.git","dest":"openwrt-passwall-packages","branch":"main"},
            {"url":"https://github.com/sos801107/luci-app-ota.git","dest":"luci-app-ota","branch":"main"},
            {"url":"https://github.com/brvphoenix/luci-app-wrtbwmon.git","dir":"luci-app-wrtbwmon","dest":"luci-app-wrtbwmon","branch":"master"},
            {"url":"https://github.com/brvphoenix/wrtbwmon.git","dir":"wrtbwmon","dest":"wrtbwmon","branch":"new"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-momo.git","dir":"luci-app-momo","dest":"luci-app-momo","branch":"main"},
            {"url":"https://github.com/nikkinikki-org/OpenWrt-momo.git","dir":"momo","dest":"momo","branch":"main"},
            {"url":"https://github.com/vernesong/OpenClash.git","dir":"luci-app-openclash","dest":"luci-app-openclash","branch":"master"},
            {"url":"https://github.com/linkease/istore.git","dest":"istore","branch":"main"}
          ]'

          # å…ˆæµ‹è¯•å•ä¸ªä»“åº“
          echo "=== æµ‹è¯•å•ä¸ªä»“åº“ ==="
          test_repo='{"url":"https://github.com/sirpdboy/luci-app-advancedplus.git","dest":"test-luci-app-advancedplus","branch":"main"}'
          if ! smart_sync "$test_repo"; then
            echo "âŒ æµ‹è¯•ä»“åº“å¤±è´¥ï¼Œåœæ­¢æ‰§è¡Œ"
            exit 1
          fi

          # å¦‚æœæµ‹è¯•æˆåŠŸï¼Œæ‰§è¡Œå…¨éƒ¨åŒæ­¥ï¼ˆå‡å°‘å¹¶å‘æ•°ï¼‰
          echo "=== å¼€å§‹åŒæ­¥æ‰€æœ‰ä»“åº“ ==="
          echo "$REPOS" | jq -c '.[]' | parallel -j 2 --halt soon,fail=1 smart_sync

          echo "âœ… æ‰€æœ‰ä»“åº“åŒæ­¥å®Œæˆ"

      - name: Commit Changes
        run: |
          cd "$GITHUB_WORKSPACE" || exit 1
          
          git config --global user.name "zxmlysxl"
          git config --global user.email "zxmlysxl@gmail.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git status --porcelain | grep -q .; then
            echo "æ£€æµ‹åˆ°å˜æ›´:"
            git status --porcelain
            git add .
            git commit -m "chore: sync repositories $(date +'%Y-%m-%d %H:%M:%S') [skip ci]"
            git push
            echo "âœ… å·²æäº¤å˜æ›´"
          else
            echo "ğŸŸ¢ æ— å˜æ›´éœ€è¦æäº¤"
          fi
