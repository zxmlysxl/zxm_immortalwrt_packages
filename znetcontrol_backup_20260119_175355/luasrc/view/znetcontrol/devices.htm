<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:在线设备%></h2>
    <div class="cbi-map-descr"><%:当前网络中的在线设备列表%></div>
    
    <div class="table cbi-section-table" id="device-table">
        <div class="tr table-titles">
            <div class="th"><%:IP地址%></div>
            <div class="th"><%:MAC地址%></div>
            <div class="th"><%:主机名%></div>
            <div class="th"><%:操作%></div>
        </div>
        <div id="device-list">
            <div class="tr">
                <div class="td" colspan="4" style="text-align: center; padding: 20px;">
                    <span style="color: #666;"><%:正在加载设备列表...%></span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="cbi-page-actions">
        <button class="cbi-button cbi-button-action" onclick="refreshDevices()">
            <%:刷新列表%>
        </button>
        <button class="cbi-button" onclick="closeWindow()">
            <%:关闭%>
        </button>
    </div>
</div>

<script>
function refreshDevices() {
    document.getElementById('device-list').innerHTML = '<div class="tr"><div class="td" colspan="4" style="text-align: center; padding: 20px;"><span style="color: #666;"><%:正在加载设备列表...%></span></div></div>';
    
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/get_devices")%>')
        .then(response => response.json())
        .then(devices => {
            let html = '';
            
            if (devices.length === 0) {
                html = '<div class="tr"><div class="td" colspan="4" style="text-align: center; padding: 20px;"><span style="color: #999;"><%:未找到在线设备%></span></div></div>';
            } else {
                devices.forEach(device => {
                    html += '<div class="tr">';
                    html += '<div class="td">' + (device.ip || '未知') + '</div>';
                    html += '<div class="td"><code>' + device.mac + '</code></div>';
                    html += '<div class="td">' + (device.hostname || '未知') + '</div>';
                    html += '<div class="td">';
                    html += '<button class="cbi-button cbi-button-action" onclick="selectDevice(\'' + device.mac + '\')" style="padding: 4px 10px;">';
                    html += '<%:选择%>';
                    html += '</button>';
                    html += '</div>';
                    html += '</div>';
                });
            }
            
            document.getElementById('device-list').innerHTML = html;
        });
}

function selectDevice(mac) {
    if (window.opener && !window.opener.closed) {
        // 如果是从父窗口打开的，设置父窗口的输入框值
        window.opener.selectDeviceFromModal(mac);
        window.close();
    } else {
        // 如果是独立打开的，显示选择结果
        alert('<%:选择的MAC地址: %>' + mac);
    }
}

function closeWindow() {
    if (window.opener && !window.opener.closed) {
        window.close();
    } else {
        window.history.back();
    }
}

window.onload = refreshDevices;
</script>
<%+footer%>
