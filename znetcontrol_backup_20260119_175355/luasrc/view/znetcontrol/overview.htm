<%+header%>
<div class="cbi-map">
    <h2 name="content"><%:佐罗上网管控%></h2>
    <div class="cbi-map-descr"><%:基于MAC地址的网络访问时间管控系统%></div>
    
    <fieldset class="cbi-section">
        <legend><%:系统状态%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:服务状态%></label>
            <div class="cbi-value-field">
                <span id="service-status" class="label">正在检查...</span>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:运行时间%></label>
            <div class="cbi-value-field">
                <code id="uptime">--</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:进程PID%></label>
            <div class="cbi-value-field">
                <code id="service-pid">--</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:统计信息%></legend>
        <div class="cbi-value">
            <label class="cbi-label"><%:总规则数%></label>
            <div class="cbi-value-field">
                <code id="total-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:启用规则数%></label>
            <div class="cbi-value-field">
                <code id="enabled-rules">0</code>
            </div>
        </div>
        <div class="cbi-value">
            <label class="cbi-label"><%:当前生效规则%></label>
            <div class="cbi-value-field">
                <code id="active-rules">0</code>
            </div>
        </div>
    </fieldset>
    
    <fieldset class="cbi-section">
        <legend><%:系统操作%></legend>
        <div class="cbi-page-actions">
            <button class="cbi-button cbi-button-apply" onclick="restartService()">
                <%:重启服务%>
            </button>
            <button class="cbi-button cbi-button-reset" onclick="stopService()" style="background-color: #f0ad4e; border-color: #eea236; color: #fff;">
                <%:停止服务%>
            </button>
            <button class="cbi-button cbi-button-action" onclick="startService()" style="background-color: #5cb85c; border-color: #4cae4c; color: #fff;">
                <%:启动服务%>
            </button>
            <button class="cbi-button cbi-button-action" onclick="refreshStatus()">
                <%:刷新状态%>
            </button>
        </div>
    </fieldset>
</div>

<script>
// 更快的状态刷新
function refreshStatus(force = false) {
    // 显示正在刷新
    if (force) {
        document.getElementById('service-status').textContent = '刷新中...';
        document.getElementById('service-status').className = 'label';
    }
    
    // 使用fetch但设置超时和重试
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/get_status")%>', {
        credentials: 'same-origin',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        updateStatusDisplay(data);
    })
    .catch(error => {
        console.error('刷新状态失败:', error);
        // 3秒后重试
        setTimeout(refreshStatus, 3000);
    });
}

function updateStatusDisplay(data) {
    const statusEl = document.getElementById('service-status');
    if (data.running) {
        statusEl.textContent = '<%:运行中%>';
        statusEl.className = 'label success';
    } else {
        statusEl.textContent = '<%:已停止%>';
        statusEl.className = 'label error';
    }
    
    document.getElementById('uptime').textContent = data.uptime || '--';
    document.getElementById('service-pid').textContent = data.pid || '--';
    document.getElementById('total-rules').textContent = data.total_rules || 0;
    document.getElementById('enabled-rules').textContent = data.enabled_rules || 0;
    document.getElementById('active-rules').textContent = data.active_rules || 0;
}

function restartService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/restart")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            setTimeout(refreshStatus, 2000);
        });
}

function stopService() {
    if (confirm('确定要停止服务吗？')) {
        fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/stop")%>')
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                refreshStatus(true);
            });
    }
}

function startService() {
    fetch('<%=luci.dispatcher.build_url("admin/control/znetcontrol/api/start")%>')
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            refreshStatus(true);
        });
}

// 页面加载时立即刷新
window.addEventListener('load', function() {
    // 立即刷新一次
    refreshStatus(true);
    
    // 然后每5秒刷新一次
    setInterval(refreshStatus, 5000);
});

// 添加手动刷新按钮点击事件
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('button[onclick*="refreshStatus"]');
    if (refreshBtn) {
        refreshBtn.onclick = function() {
            refreshStatus(true);
            return false;
        };
    }
});
</script>

<style>
.label {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: bold;
}

.label.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.label.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.cbi-button-reset {
    background-color: #f0ad4e;
    border-color: #eea236;
    color: #fff;
}

.cbi-button-reset:hover {
    background-color: #ec971f;
    border-color: #d58512;
}
</style>
<%+footer%>
